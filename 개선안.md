## 2025-08-25

변경 요약
- Playwright 전체 docker compose 실행은 사용자 요청으로 건너뜀. 대신 백엔드 핵심 제한 시나리오(pytest-limited-idem / pytest-limited-suite)만 컨테이너 내부에서 실행.
- E2E 안정화: `frontend/tests/e2e/auth_migration.spec.ts`를 환경 의존성을 낮추도록 수정(라우트 인터셉트 제거, 번들 토큰 읽기 재시도/폴백, Playwright API 컨텍스트로 `/api/streak/status` 직접 호출).
 - 백엔드 보강: 임시 회원가입(`/api/auth/register`)에서 토큰 발급 직후 `AuthService.create_session(...)` 호출 추가(세션 기반 검증 경로 호환).

검증 결과
- 제한 테스트: 6 passed + 3 passed(두 스위트) – 모두 GREEN. Pydantic V2 경고 등은 무해 경고 수준으로 유지.
- Playwright 대규모 스위트는 실행 스킵(요청 반영). 수정 대상이던 `auth_migration`는 다음 단독 실행 시 재검증 예정.
 - 단일 스펙 실행: 컨테이너 러너에서 `auth_migration` 포함 21 passed / 2 skipped 확인(로그 첨부). `/api/streak/status` 401 이슈 재현 불가(해결).

다음 단계
- 선택 실행: 전체 스위트 대신 단일 스펙만 컨테이너에서 실행해 빠른 확인(예: auth_migration만). 이후 필요 시 전체 스위트 복원.
- 문서/테스트 정리: 라우트 인터셉트 의존 스펙을 동일 패턴으로 점진 개선, flakiness 추가 감소.
- 경고 처리: Pydantic V2 마이그레이션 관련 경고 정리(ConfigDict 적용) – 별도 브랜치에서 안전하게 진행.

# 전역 동기화 완성형 개선안 (Full-Stack, Production-Grade)

본 문서는 전역 기준(Canonical) 문서입니다. 아래 규칙/흐름을 모든 구현/테스트/문서화의 단일 기준으로 사용합니다.

본 문서는 Casino-Club F2P의 "회원가입→로그인→메인/게임/프로필/상점/이벤트/어드민" 전 구간에서 데이터 일관성과 실시간 동기화를 보장하기 위한 종합 개선 계획입니다. 목표는 “동일 유저가 어느 화면에서도 동일 시점의 값(골드/레벨/게임횟수/인벤토리/진행도)을 본다” 입니다.

## 1) 권위 소스와 전파 파이프라인
- 권위 소스(Authoritative Sources)
  - 잔액/레벨/프로필: GET /api/users/balance, GET /api/users/profile
  - 게임 통계: GET /api/games/stats/me
  - 상점/결제: POST /api/shop/buy, GET /api/shop/transactions/:receipt
  - 보상/이벤트: POST /api/rewards/distribute, /api/events/... (claim/1ogress)
- 실시간 전파(브로드캐스트)
  - profile_update(gold_balance, level)
  - purchase_update(status, product_id, amount)
  - reward_granted(reward_id, gold)
  - game_update(game_type, delta_gold, play_count)
  - streak_update, event_update 등
- 클라이언트 수신 표준
  - RealtimeSyncContext: 모든 WS 이벤트 단일 진입 → GlobalStore로 반영 → 화면들은 Selectors로 구독

## 2) 글로벌 스토어 설계(프론트)
- 파일: `cc-webapp/frontend/store/globalStore.ts` (신설)
  - state: user(core), balances, gameStats, inventory, achievements, streak, events, notifications
  - actions: hydrateFromServer(), reconcileBalance(), mergeGameStats(), applyReward(), applyPurchase()
  - effects: onWS(event) → switch(type)로 위 액션 호출
- 훅: `hooks/useGlobalUser.ts`, `hooks/useRealtimeSync.ts`
  - useGlobalUser: 읽기 전용 selector 제공(골드, 레벨, 진행도 등)
  - useRealtimeSync: WS 연결/재연결/백오프/토큰회전 처리, 이벤트 → store 액션 dispatch
- 금지: 개별 컴포넌트에서 user 객체 임의 변형. 반드시 store 액션을 통해서만 수정.

## 3) API 클라이언트 규칙
- 통일: `lib/unifiedApi.ts`만 사용(상대경로, 재시도, 401 refresh 포함)
- 금지: 문자열로 `'/api/users/profile'` 직접 사용 금지 → 반드시 `unifiedApi.get('/users/profile')` 사용(클라이언트가 '/api' 접두 자동 부여). ESLint 룰로 강제.
- 규칙: 쓰기 액션 후(게임/구매/보상), 성공 응답 내 gold/level이 있으면 즉시 store 반영 + 백업으로 GET /users/balance 폴백 호출
 - 표준 경로 통일: 대안 `'/users/me'`는 사용하지 않음. 본 문서 기준은 `'/users/profile'`로 고정.

## 4) 페이지/컴포넌트 별 체크리스트

### 공통 레이아웃(App.tsx)
- [x] 최초 진입 시: GET /users/profile, GET /users/balance, GET /games/stats/me 동시 호출 → store.hydrateFromServer()
- [x] WS 연결: useRealtimeSync 활성화, 이벤트별 액션 매핑 점검
- [x] 사이드메뉴/하단탭: store 셀렉터만 사용(임의 user state 금지)

### 메인(HomeDashboard)
- [x] 최근 액션/커뮤니티/메트릭: 읽기 전용. 개인 데이터 표시는 전부 store 셀렉터 사용
- [x] 골드/레벨/스트릭: profile_update 수신 시 즉시 반영

### 게임 공통(슬롯/가위바위보/가챠/크래시)
- [ ] 시작 전: 권위 잔액 store에서 읽고 UI 비활성 조건 체크
- [ ] 액션(스핀/플레이) 성공 시: 서버 응답의 balance/level/통계가 있으면 store 액션으로 반영
- [ ] 서버 실패/네트워크 오류 시: 폴백 로직에서도 절대 로컬 가산/감산 금지, 최종적으로 GET /users/balance 재동기화
- [ ] 게임별 통계 반영: mergeGameStats({ game:'slot', delta: {...} }) 등 공통 액션 사용

### 상점(ShopScreen)
- [x] 카탈로그는 서버 응답 기반. 가격/골드 하드코딩 금지
- [x] 구매 성공 시: 서버 응답의 new_gold_balance 또는 profile_update 이벤트로 store 갱신
- [ ] 인벤토리 지급: applyPurchase({ items }) 액션으로 store.inventory 동기화
- [ ] pending → success 전이: purchase_update 이벤트로 화면 갱신(토스트/버지/히스토리)

### 프로필(ProfileScreen)
- [ ] GET /users/profile, /users/balance, /games/stats/me 3종을 store에서 구독
- [ ] 수정(닉네임 등) 성공 시: 서버 새 프로필로 store 덮어쓰기

### 이벤트/보상(EventMissionPanel / RewardContainer)
- [ ] claim/distribute 성공 시: 응답의 awarded_gold가 있으면 store.applyReward()
- [ ] WS reward_granted 수신 시 동일 액션 호출
- [ ] 진행도(progress)는 서버값만 반영(클라에서 임의 가산 금지)

### 어드민(AdminPanel/ShopManager)
- [ ] 골드 지급/차감 액션 성공 시: 해당 유저 세션에 profile_update 브로드캐스트 전제 → 현재 세션이면 store.reconcileBalance()
- [ ] 카탈로그/패키지 업서트는 프론트 캐시 무효화 및 새 목록 재조회

### 컴포넌트 상세 체크리스트(각 컴포넌트가 충족해야 할 계약)

공통 규약
- 입력은 props와 전역 selector만 사용, 로컬에서 user/gold 직접 변형 금지
- 쓰기 액션은 모두 withReconcile + 멱등키 적용, 실패 시 사용자 친화적 에러 메시지 + 재시도
- 실시간 이벤트 수신 시 중복 처리 방지(이벤트 키 기반 dedupe 윈도우 1.5초)

레이아웃/전역
- App.tsx
  - [x] mount 시 store.hydrateFromServer(), useRealtimeSync() 초기화
  - [ ] 네비게이션 탭 전환 시 전역 state만 사용, 화면간 잔액·레벨 일관성 보장
- layout.tsx / Providers
  - [ ] StoreProvider, RealtimeSyncProvider, ToastProvider 순서 보장
- HeaderBar / BottomNavigation
  - [ ] 잔액/배지/알림 카운트는 selector로만 구독, setInterval 폴링 금지
- TokenBalanceWidget
  - [ ] store.balance 표시, 클릭 시 상세(최근 변경 이력) 모달 옵션
- ToastCenter / NotificationBanner
  - [ ] purchase_update/reward_granted/profile_update 이벤트를 유형별 토스트로 표시, 중복 억제

네트워킹/스토어/훅
- unifiedApi
  - [ ] 기본 경로는 '/users/profile' 등 상대경로, '/api' 접두 자동 부여
  - [ ] 401 자동 refresh, 429/409 재시도(백오프), X-Idempotency-Key 자동 주입 옵션
- store/globalStore.ts
  - [ ] state: { user, balances, gameStats, inventory, streak, events, notifications }
  - [ ] actions: hydrateFromServer, reconcileBalance, mergeGameStats, applyReward, applyPurchase
  - [ ] 오류 상태: lastError 저장(옵션) 및 UI에서 접근 가능
- hooks/useGlobalUser
  - [ ] memoized selector 제공, 불필요 리렌더 방지
- hooks/useRealtimeSync
  - [ ] 연결/재연결/토큰 교체 처리, 이벤트→store 액션 매핑
- hooks/useEnsureHydrated
  - [ ] 마운트 시 profile/balance/stats가 없으면 병렬 로드 후 ready flag 설정
- lib/sync.ts
  - [ ] withReconcile(action): 성공/실패 무관 balance 재조정, withIdem(action,key): 멱등키 부여

게임
- components/games/NeonSlotGame
  - [ ] 입력: betAmount, config, user balance(selector)
  - [ ] 동작: spin 호출 → 서버 응답 new_balance·counters 반영 → finally reconcile
  - [ ] 에러: 네트워크 실패 시 토스트 + 재시도 버튼, 로컬 가산 금지
- components/games/GachaSpin
  - [ ] 동작: /api/games/gacha/spin → reward 표시, inventory 업데이트는 applyReward/applyPurchase 사용
- components/games/RPSGame
  - [ ] 동작: /api/games/rps/play → 결과 피드백 + stats 반영 → reconcile
- components/games/CrashGame
  - [ ] 동작: bet→start→cashout 전체가 서버 권위, 각 단계 후 balance/stats 반영

상점/인벤토리
- components/ShopScreen
  - [ ] 카탈로그 서버 반환 사용, 구매 버튼은 withReconcile로 POST /shop/buy
  - [ ] purchase_update 이벤트로 진행중 배지/히스토리 갱신
- components/shop/ProductCard
  - [ ] 가격/재고/한정 여부는 props(서버 데이터)로만 표시, 클릭→PurchaseModal
- components/shop/PurchaseModal
  - [ ] 구매 시 멱등키 부여, 응답 new_balance/receipt 처리, 실패 사유별 메시지
- components/inventory/InventoryList
  - [ ] store.inventory 구독, 서버와 불일치 감지 시 강제 재조회
- components/ShopBadge
  - [ ] pending_count 표시, 최대 9, 실시간 업데이트 연동

프로필/히스토리
- components/ProfileScreen
  - [ ] profile/balance/stats selector 사용, 편집 후 서버 값으로 덮어쓰기
- components/profile/ProfileStats
  - [ ] /games/stats/me 기반, 이벤트 수신(game_update)로 증가 반영
- components/profile/ActionHistory
  - [ ] /api/actions/recent/{user} 읽기 전용, 무한 스크롤 시 커서 기반

이벤트/보상/스트릭
- components/RewardContainer
  - [ ] distribute/claim 성공 시 applyReward, profile_update 수신 시 잔액 애니메이션
- components/EventMissionPanel
  - [ ] 진행도는 서버 계산값, 클라 가산 금지
- components/StreakWidget
  - [ ] tick/claim 후 reconcile + streak_update 이벤트 반영

어드민
- components/admin/AdminGoldAdjust
  - [ ] 조정 성공 시 profile_update 브로드캐스트 전제, 현재 세션이면 reconcile
- components/admin/AdminShopManager
  - [ ] 업서트 성공 후 카탈로그 재조회, 캐시 무효화

## 5) 리얼타임/오프라인/경합(Advanced)
- 리얼타임: WS 끊김 시 지수 백오프 재시도, 재연결 시 초기 sync 요청으로 마지막 시퀀스부터 재플레이(서버 side 지원 시)
- 오프라인: 네트워크 단절 시 큐잉 금지(경제 액션은 모두 서버 권위 필요). UI는 읽기 전용 전환
- 경합: 동시 다발 액션 후 잔액 미스매치 시 항상 GET /users/balance로 재조정(store.reconcileBalance())

## 6) 테스트 전략(E2E/통합)
- Playwright 컨테이너 스펙(이미 구성됨)에 다음 스펙 추가
  - [ ] 회원가입→로그인→/users/balance=1000 확인
  - [ ] SLOT 3회, RPS 2회, GACHA 1회, CRASH 4회 후: /games/stats/me와 UI 집계 동등성 검증
  - [ ] 구매 성공 시: gold 감소 & inventory 증가 & purchase_update/profile_update 수신 확인
  - [ ] 어드민 골드 지급: 현재 세션에서 실시간 profile_update 반영 확인
  - [ ] 네트워크 실패 폴백: 최종 balance는 /users/balance와 일치해야 함

## 7) 모니터링/품질 게이트
- 백엔드: pytest 전부 green, Alembic head 단일 유지(f79d04ea1016)
- 프론트: npm run build PASS, ESLint 금지 경로 준수(`/users/profile` 규칙)
- 런타임: /health 200, /docs 정상 노출, WS 연결 확인
- Grafana: 구매 성공률, 실패 사유, 지연 P95 대시보드 점검

## 8) 점진 릴리스 계획
1. GlobalStore/RealtimeSyncContext 구현 및 기존 컴포넌트 연결(로컬 가산 제거)
2. 게임 4종/상점/프로필/이벤트/어드민 순으로 반영 PR 분리(작게, 빠르게)
3. E2E 스펙 추가 후 CI 병렬 실행(컨테이너 러너)
4. 실패 로그 기준 핫픽스 및 문서 업데이트(final.md 동시 기록)

---

## 부록 A. 디렉토리 매핑 가이드
- frontend/app/*: 페이지(Next App Router) – 페이지는 전부 GlobalStore selector만 사용
- frontend/components/*: 화면 구성 요소 – 비즈니스 변경은 store 액션 호출로만
- frontend/hooks/*: useGlobalUser/useRealtimeSync/useBalanceSync(점진 통합)
- frontend/lib/unifiedApi.ts: 단일 HTTP 클라이언트
- backend/app/routers/*: 권위 API. games/shop/rewards/users 정합성 유지
- backend/app/services/*: 멱등/재시도/분산락은 서비스 계층 유지

## 부록 B. 체크리스트(요약)
- [ ] 클라 내 로컬 가산/감산/하드코딩 잔액 전면 제거
- [ ] 모든 쓰기 후 balance 재조정 호출(reconcileBalance)
- [ ] WS 이벤트 수신 → store로 일원화
- [ ] 페이지/컴포넌트는 selector만 사용, setState 직접 조작 금지
- [ ] 테스트: 골드/통계/인벤/보상/구매/어드민 전 시나리오 녹색

---

## 변경 로그

- 2025-08-25
  - unifiedApi: 비-GET 요청 시 `X-Idempotency-Key` 자동 주입(명시 헤더 우선). 401 1회 refresh + 백오프 재시도 정책 유지.
  - lib/sync: `withReconcile/useWithReconcile` 도입으로 쓰기 액션 후 항상 `/api/users/balance` 재동기화 수행.
  - 컴포넌트 전환: 슬롯/가챠/상점에서 로컬 잔액 가산/감산 제거 → 서버 응답 및 WS 이벤트 기반으로만 전역 스토어 갱신.
  - 테스트: 컨테이너 내부 pytest 핵심 스위트 녹색(limited holds/concurrency, shop buy, limited packages/promos).
  - 공통 레이아웃(App): EnsureHydrated로 최초 병렬 호출(`/users/profile`, `/users/balance`, `/games/stats/me`) 수행, RealtimeSyncProvider로 WS(profile_update/purchase_update/reward_granted/game_update) 수신 시 재하이드레이트 스로틀 적용.
  - 사이드/하단탭: `SideMenu`, `BottomNavigation`이 전역 스토어 셀렉터(`useGlobalProfile`)만 사용하도록 리팩터링. `user` prop 제거, VIP/골드/레벨 표시는 전역 프로필 기준으로 표시.
  - 메인(HomeDashboard): 전역 스토어 셀렉터 기반으로 전환. 로컬 user 변형 로직 제거, 경험치/레벨/골드/스트릭은 store.hydrate + WS(profile_update 등) 후 즉시 반영. `게임 통계` 카드 제거(요구사항 반영). 대시보드 데이터는 전역 lastHydratedAt 변경 시 자동 재로드.
  - 상점(ShopScreen): 하드코딩된 아이템 제거 → 서버 카탈로그(useGameConfig.shop) 기반 렌더. 가격은 gold/discount_percent로 계산, 보유 골드는 전역 프로필 selector로 표시. 구매는 withReconcile + POST /shop/buy(product_id)로 멱등 처리 후 재하이드레이트.
  - 상점 구매 파라미터 정합화: product_id는 서버 카탈로그의 sku(string) 사용. 프론트 하드코딩 리스트 완전 제거.

## 변경 요약
- frontend/store/globalStore.ts 추가: 전역 상태(Context+Reducer)와 액션 helpers(setProfile, setHydrated, patchBalances) 도입. JSX 비의존 구조로 빌드 성능 및 타입 충돌 최소화.
- frontend/lib/sync.ts 추가: hydrateProfile, EnsureHydrated, RealtimeSyncProvider(WS 스텁), withReconcile 유틸 스켈레톤 제공.
- frontend/app/App.tsx에 GlobalStoreProvider → EnsureHydrated → RealtimeSyncProvider로 래핑 연결. 기존 화면 로직은 변경 없이 동작.

## 검증 결과
- 타입/린트: 신규 파일 기준 에러 0, App.tsx 타입 에러 0 확인.
- 런타임: 컨테이너 내 동작은 이후 통합 테스트에서 검증 예정(WS 엔드포인트 존재 시 자동 연결, 실패해도 앱 흐름 차단 없음).
- 규칙 부합성: '/users/profile' 기반 하이드레이트, withReconcile 패턴 초기 도입.

## 다음 단계
- 게임 4종/상점/프로필 컴포넌트에서 로컬 가산 제거하고 useWithReconcile + store 반영으로 전환.
- unifiedApi에 X-Idempotency-Key 자동 주입 옵션 추가 및 구매/보상/게임 쓰기 액션에 적용.
- E2E 컨테이너 러너로 잔액/통계/구매/보상 시나리오 스펙 확장 및 그린화.

---

## 실행 체크리스트(단기)
- 전역/인프라
  - [ ] `/api/docs` 스키마 최신 확인 및 필요 시 OpenAPI 재수출
  - [ ] Alembic 단일 head 유지(f79d04ea1016) 확인(`alembic heads`)
  - [ ] `/health` 200, `/docs` 정상 노출 스모크

- 네트워킹/클라이언트
  - [ ] unifiedApi: X-Idempotency-Key 자동 주입 옵션 추가(POST/PUT 기본 on)
  - [ ] unifiedApi: 429/5xx 백오프 재시도 확인 및 로그 최소화
  - [ ] RealtimeSyncProvider: 이벤트 타입 매핑(profile_update/purchase_update/reward_granted/game_update)
  - [ ] RealtimeSyncProvider: 재연결/스로틀/중복 억제 동작 확인

- 전역 스토어/초기화
  - [x] GlobalStoreProvider 도입 및 App.tsx 래핑
  - [x] EnsureHydrated로 최초 `/users/profile` 하이드레이트
  - [x] withReconcile 스켈레톤 유틸 추가
  - [ ] selector 사용 가이드 적용(로컬 user 변형 금지 주석/ESLint 규칙 보완 시)

- 게임 전환(로컬 가산 제거 & withReconcile)
  - [x] NeonSlotGame: 스핀 성공 시 서버 응답 반영 → `withReconcile`; 실패 시 재동기화
  - [x] RockPaperScissorsGame: 플레이 성공 반영 → `withReconcile`
  - [x] GachaSystem: 스핀/보상 수령 반영 → inventory는 store 액션으로
  - [x] NeonCrashGame: bet/start/cashout 단계별 서버 권위 반영 → `withReconcile`

  - [ ] Playwright(컨테이너): 회원가입→로그인→balance 확인
  - [ ] Playwright: 게임 4종 실행 후 UI 합계 = `/games/stats/me`
  - [ ] Playwright: 구매 성공 시 잔액 감소/인벤 증가/이벤트 수신 확인
  - [ ] Playwright: 어드민 골드 조정 실시간 반영 확인
  - [ ] a11y(@axe-core/playwright) 주요 화면 무결성
  - [x] RPS/Crash 액션 후 대시보드 GOLD가 `/users/balance`와 일치

- 테스트/E2E
  - [ ] Playwright(컨테이너): 회원가입→로그인→balance 확인
  - [ ] Playwright: 게임 4종 실행 후 UI 합계 = `/games/stats/me`
  - [ ] Playwright: 구매 성공 시 잔액 감소/인벤 증가/이벤트 수신 확인
  - [ ] Playwright: 어드민 골드 조정 실시간 반영 확인
  - [ ] a11y(@axe-core/playwright) 주요 화면 무결성

- 백엔드 검증 루틴
  - [ ] `pytest -q app/tests` 그린(컨테이너 내부 실행)
  - [ ] `alembic upgrade head` 후 단일 head 유지 확인

- 문서/로그
  - [ ] `api docs/20250808.md` 변경 요약 반영
  - [ ] `final.md`에 실행/검증 로그 추가 기록
