# MVP 출시 우선순위 정리 (배틀패스/성인콘텐츠 제외)

## 0. 범위 정의
- 제외: 배틀패스 전 기능, AdultContent 관련 전 기능, 심리 측정 퀴즈, 실시간(WebSocket/라이브 통계), 업적/리더보드/소셜, 고급 프로모션/한정 패키지(선택 연기).
- 목표: 인증 → 코어 게임(슬롯/가챠) → 행동로깅 → 보상/통화 → 상점/구매 → 기본 대시보드 폐쇄 루프 안정화.

## 1. MUST (출시 전 필수)
### 1.1 인프라 & 안정성
- ⚠️ 주요 테이블/인덱스/제약조건 설계 확정 (1차 감사/제안 완료 → 마이그레이션 적용 중)
- ✅ 백업/복구 전략 수립 + 스크립트/Runbook 작성 (실제 복구 스모크 예정)
- ✅ 로깅 설정 (구조화 JSON + request_id/user_id contextvars 적용)
- ✅ 에러 핸들링 미들웨어 (표준 오류 스키마 + 도메인/HTTP/Validation 통합)
- ✅ 사용자 정의 예외 클래스 (AuthError, AuthorizationError, NotFoundError 등 도입)
- ✅ API 문서화(OpenAPI export: canonical + timestamped snapshot 생성 스크립트)

### 1.2 인증/사용자
- [✅] JWT 인증 및 권한 관리 (초대코드/닉네임 기반, VIP 필드 존재만) — /api/auth/signup, /api/auth/login 추가, HS256 JWT 발급
- [✅] 초기 사용자 설정 (등급 STANDARD, 초기 cyber_token_balance=200)
- [✅] 코드 보안: DEFAULT_INVITE_CODE 난수화 & 환경변수화 (미지정 시 프로세스별 난수 생성 + 로그 경고)
	- 추가 플래그: ENFORCE_DB_INVITE_CODES=1 설정 시 DB 등록 코드(또는 UNLIMITED_INVITE_CODE=5858)만 허용
	- Unlimited 코드(운영 정책): UNLIMITED_INVITE_CODE 기본값 5858 은 '의도적으로 **영구 허용**되는 초기 운영용 마스터 초대 코드'로 정의됨. 이는 다음 조건을 충족해야 함:
		1) 모든 환경(.env / Secret Manager)에서 값이 명시적으로 추적되며, 변경 시 배포 릴리스 노트 기록
		2) 보안 로그에서 5858 사용 가입 건 주기적(예: 일/주 단위) 집계 모니터링
		3) 일반 사용자용 공개 UI/문서에 해당 코드 직접 노출 금지 (운영/QA 내부 공유 전용)
		4) 회전(Rotation) 권고: MVP 안정 후(예: 사용자 1k+ 시점) 신규 난수형(6~8자 영숫자) 코드 생성 → 기존 5858 사용 중단 공지 (Grace 기간 ≥7일) → ENFORCE_DB_INVITE_CODES 활성화 전환
		5) ENFORCE_DB_INVITE_CODES 활성화 시 5858 을 DB에 whitelist 레코드로 명시적으로 저장하거나 아예 운영 종료 여부 결정
	- Rotation 체크리스트 (준비 템플릿):
		- [✅] 5858 사용량(최근 30일) 분석 / 리포트 아카이빙 (INVITE_5858_USAGE_REPORT_20250817.md 생성)
		- [✅] 코드 전환 릴리스 태그 + 문서(CHANGELOG / RELEASE_NOTES) 업데이트 (태그 생성 예정 단계 아래 기록)
		- [✅] 모니터링 알람 규칙(허용되지 않은 마스터 코드 시도) 활성화 (invite_code_alerts.yml 추가)
	- Rotation Runbook (실행 절차 상세):
		
	
### 1.3 코어 게임 루프 & 피드백
- [✅] SlotMachineComponent 서버 연동 완료 (POST /api/games/slot/spin → 서버 권위 + 네트워크 실패 시 로컬 RNG 폴백 유지)
- [✅] GachaSpinComponent 서버 연동 완료 (POST /api/games/gacha/pull 단/10연; pull_count 파라미터; 서버 아이템 변환 → UI; 실패 시 기존 클라이언트 시뮬레이션 폴백)
- [✅] 피드백 알림 시스템 (FeedbackProvider + useFeedback 훅 + 조건부 토스트 렌더) ※ 디자인 영향 없음 (DOM 삽입: 토스트 존재 시만)
- [🟡] 사용자 행동 로깅 API (DB 기록) — 슬롯/가챠 서버 호출 경로 확보됨 → 다음 단계: 표준 ActionLog 스키마 확정 & GameService emit 확장 (Kafka→OLAP 연동은 이후)
	- 추가 메모: 토큰 획득/차감 authoritative balance 반영 준비 완료, 임시 useAuthToken 훅 도입(만료/회전 T.B.D.)

### 1.4 게임 데이터/통계
## 1.5 프론트엔드 API 기본 URL 구성
Frontend API Base URL Fix: ✅ Added normalization to prevent duplicate /api/api calls; ensure NEXT_PUBLIC_API_URL should typically NOT include trailing slash. If backend routers already include /api prefixes (they do), you may set NEXT_PUBLIC_API_URL to just protocol+host[:port] (e.g. http://localhost:8000) OR include single /api (http://localhost:8000/api). Mixed configurations previously caused silent 404 due to /api/api duplication; now auto-normalized with a console warning.
- [✅] 게임별 상세 통계 구현
- [✅] 게임 히스토리 조회 기능
- [✅] WebSocket 연동 (RealtimeHub /api/games/ws, /api/games/ws/monitor 구현 및 테스트 통과)
- [✅] 실시간 게임 세션 모니터링 (monitor snapshot + 이벤트 브로드캐스트 기본형 완료)

- [✅] 푸시 알림 연동 (업적 unlock 알림 + WS 이벤트)
- [✅] 업적 시스템 구현 (모델/마이그레이션/서비스/엔드포인트/평가 훅)
- [ ] 배지 및 보상 UI (프론트 표시 및 실시간 반영 남음)


## 관리자 기능 점검 결과 (요약)

### 1.5 상점/과금
- [ ] 상점 상품 관리/표시 (Premium Gem, 기본 패키지)
- [ ] 구매 로직 (POST /api/shop/buy) 멱등 + 통화 차감
- [ ] 화폐 시스템 (Regular/Premium 잔액 컬럼 및 적립/차감 서비스)
- (선택) 한정 패키지 / 프로모션 관리: 시간 부족 시 LATER 이동

### 1.6 프론트 사용자 여정
- [ ] 랜딩 페이지 (Hero + 초대코드 진입)
- [ ] 초대코드 입력 화면
- [ ] 회원가입/로그인 모달
- [ ] 온보딩 튜토리얼 (2~3 스텝 최소)
- [ ] 홈 대시보드 (잔액/최근 보상/슬롯·가챠 진입)

### 1.7 테스트 (최소 품질 게이트)
- [❌] 단위 테스트 핵심(인증, 구매, 게임 보상, 행동 로깅)
- [❌] 통합 테스트: 온보딩→슬롯/가챠→구매→잔액 검증 흐름

### 1.8 VIP (표시 최소)
- [ ] VIP 등급 표시(읽기) — 업그레이드 로직 세부는 SHOULD/LATER

## 2. SHOULD (시간 남으면)
- [⚠️] 백업/복구 스크립트(ps1) 고도화 & 자동화 체크
- [⚠️] 특별 보상 처리(이벤트/프로모) 기본 enum 설계
- [⚠️] 출석 달력 데이터 모델(엔드포인트/캘린더 UI 제외)
- [⚠️] 보호/복구 옵션(스트릭 보호) 컬럼/플래그 예약
- [ ] VIP 혜택/업그레이드 UI 보강(비교표, 진행률 바)
- [ ] 피드백 메시지/애니메이션 키 세분화 맵핑
- [ ] 개인화된 추천 UI 스켈레톤 (빈 데이터 시 placeholder)
- [ ] 추천 API 엔드포인트 스켈레톤(200 + TODO 주석)

## 3. LATER (MVP 이후)
- Kafka→OLAP 실시간 행동 분석 파이프라인
- 로그 압축/아카이빙
- 스트릭 레벨/복구 혜택 UI
- 세그먼트 기반 추천 실제 알고리즘 & 사이버 토큰 미션
- RFM 배치/세그먼트 히스토리 추적
- Capture 다중 재시도 정책 파라미터화 / 부분 환불 보정 로직
- VIP 업/다운그레이드 정책 & 자동화
- 온보딩 확장형 튜토리얼/고급 효과
- 고급 프로모션/한정 패키지 로테이션
- WebSocket 실시간 모니터링 / 라이브 통계 / 푸시
- 업적 시스템 / 배지 UI / 리더보드 / 소셜 기능
- 성능 최적화(고빈도 액션 샤딩, 캐시 계층화)

## 4. DROP / EXCLUDE (현 스코프 제외)
- 영수증 발행 및 기록 (🚫)
- AdultContent 관련 모든 항목 (StageComponent, 퀴즈, UI/API)
- 배틀패스 전체 기능
- 심리 측정 퀴즈(제출/분석 API + UI)

## 5. 수량 개요 (상위 MUST)
| 영역 | MUST 항목 수(상위) |
|------|------------------|
| 인프라/안정성 | 6 |
| 인증/사용자 | 3 |
| 코어 게임 & 피드백 | 4 |
| 게임 데이터/통계 | 2 |
| 상점/과금 | 3~4 |
| 프론트 여정 | 6 |
| 테스트 | 2 |
| VIP 표시 | 1 |
| 합계 | 약 27 |

## 6. 실행 순서 (추천 스프린트 흐름)
1) DB 스키마 & 제약조건 확정 → 초기 마이그레이션 / Alembic 단일 head 유지
2) 인증 + 사용자 초기값 + 초대코드 난수화
3) 슬롯/가챠 서비스 & 보상 계산 + 행동 로깅 API (DB)
4) 상점/구매 트랜잭션 + 화폐 시스템 → 홈 대시보드 연결
5) 프론트 온보딩 흐름(랜딩→가입/로그인→튜토리얼→게임 진입)
6) 로깅/에러/예외 + OpenAPI 정비
7) 핵심 단위/통합 테스트 및 CI 기준 잠금
8) 백업 스모크 & VIP 표기 마감 → MVP 태그

## 7. 완료 정의(Definition of Done) 체크
- 인증/구매/슬롯/가챠/피드백/로깅/데이터 저장 End-to-End 테스트 통과
- 마이그레이션: alembic heads 단일 유지 + downgrade 스모크
- OpenAPI 최신화(`current_openapi.json`) 반영
- 백업 덤프/복구 1회 성공 로그 기록
- 핵심 경로 테스트 커버리지 ≥60~65% (향후 80% 목표 에스컬레이션)

---
(원본 상세 목록은 재분류·축약됨. 세부 하위 태스크는 이 문서 기반으로 Issue/Ticket 생성 권장.)

---
### 추가: 코어 게임 통합 작업 요약 (2025-08-17)
변경 요약:
- 슬롯/가챠 모두 서버 권위 호출 + 실패 시 로컬 폴백 패턴 확립
- 공통 피드백 fromApi 경로 적용으로 메시지/애니메이션 훅 단일화
- 임시 토큰 획득 훅(useAuthToken) 도입 → 후속 만료/회전 처리 예정

검증 결과:
- 프론트 TypeScript 오류 0 (NeonSlotGame / GachaSystem 수정 후 tsc 통과 범위 내 확인)
- 문서(본 파일 1.3 섹션) 최신화, OpenAPI 엔드포인트 기존 /api/games/slot/spin /api/games/gacha/pull 사용
- 폴백 경로 수동 테스트(네트워크 예외 시 로컬 RNG 유지) 설계 반영

다음 단계:
1) 사용자 행동 로깅 API 표준화 (액션 타입/보상/세션ID 스키마) + GameService emit 확정
2) 토큰 훅 고도화 (만료/자동 재발급 + 401 재시도)
3) 피드백 severity/animation → UI 아이콘/효과 매핑 테이블화
