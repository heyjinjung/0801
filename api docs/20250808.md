# Casino-Club F2P 통합/정비 가이드 (2025-08-08)

## 1. 현황 및 문제 요약

- **중복 파일 다수**: `_simple`, `_fixed`, `_temp`, `_direct`, `_v2` 등 접미사로 분기된 파일이 많아 유지보수 혼란.
- **API 라우터 중복/불일치**: games, game_api, game_api_v2 등 유사 기능이 여러 파일에 분산되어 일관성 저하.
- **환경/설정 파일 중복**: config.py, config_simple.py 등 환경설정이 분리되어 통합 배포/운영에 문제.
- **풀스택 연결 오류**: 프론트-백엔드, DB, 인증 등 연결이 불안정하거나 일부 경로가 동작하지 않음.

---

- **단일 진입점/단일 소스 유지**: 동일 목적의 파일은 하나만 남기고, 개선점은 통합.
- **모듈별 책임 명확화**: 인증, 게임, 유저, 관리 등 도메인별로 라우터/서비스/스키마 분리.
- **환경설정 일원화**: config.py 하나로 통합, .env 사용 권장.
- **API 스펙/문서 자동화**: OpenAPI/Swagger 기반 문서 자동 생성.
- **테스트/배포 자동화**: 통합 테스트, CI/CD 파이프라인 구축.


## 3. 단계별 통합/정비 체크리스트

### 1) 중복 파일 정리
- [x] *_simple.py, *_fixed.py, *_temp.py, *_direct.py, *_v2.py 등 불필요 파일 삭제
- [x] config.py, dependencies.py 등 환경/의존성 파일 단일화

- [x] games.py에 game_api, game_api_v2 기능 병합
- [x] auth.py에 simple/clean/temp 기능 병합
- [x] OpenAPI 스펙 재생성 및 문서화 (파일: `cc-webapp/backend/current_openapi.json`)

### 3) 환경설정/배포 통합
- [ ] CI/CD 파이프라인 구축 (GitHub Actions 등)
---

## 4. 베스트 프랙티스 & 주의사항

- **모든 통합/삭제 작업 전 git backup 브랜치 생성**
- **API 변경 시 프론트엔드/문서/테스트 코드 동시 수정**
- **불필요한 주석/코드/파일은 즉시 제거**
- **문서(README, API docs) 최신 상태 유지**
---

## 5. 참고 문서
- file-comparison-report.md
- README-SIMPLE.md


## 6. 빠른 점검용 체크리스트 (복붙용)

 - [x] 핵심 라우터/서비스/스키마만 남겼는지 확인
- [ ] config.py/.env만 남기고 환경설정 통일
- [x] API 문서/스펙 최신화 (OpenAPI 갱신 및 경로 표준화)
- [ ] 전체 테스트 통과
- [ ] git commit/backup 완료

---

 - 중복 파일 정리: 루트 `cc-webapp/current_openapi.json` 제거 완료
- 생성 방식: 컨테이너 내부에서 `python -m app.export_openapi` 실행 시 자동 갱신

## 8. Next Steps

 - [완료] RPS 플레이 엔드포인트 OperationId 정리: 고유 `operation_id` = `games_rps_play_v1`
 - [다음] 프론트-백엔드 경로/스키마 최종 동기화 체크 및 최소 UI 스모크 플로우
 - [다음] 통합 테스트 보강 및 CI/CD 파이프라인 구축 (GitHub Actions 등)
 - [다음] DB 마이그레이션 정식화 (Alembic) 및 초기 데이터 시드 스크립트 편입
 - Admin: Added notifications endpoints
  - POST /api/admin/notifications/send (targeted WebSocket notification)
  - POST /api/admin/notifications/broadcast (broadcast to all connected)
 - Admin: Added bulk rewards grant endpoint
  - POST /api/admin/rewards/grant-bulk (per-user result with ok/error)
 - OpenAPI: Exported latest schema (backend/current_openapi.json) reflecting new endpoints.

### 8.1 검증 가이드 (Admin 신규 엔드포인트/WS)

사전 준비
- 백엔드·DB 컨테이너 기동 상태 확인 (http://localhost:8000/health = 200)
- 테스트용 관리자 계정 준비(권장): 기존 계정을 관리자 승격하거나 관리자 토큰 사용
	- (선택) 관리자 승격 예시: 컨테이너 내부 스크립트 활용
		- PowerShell
			```powershell
			docker exec cc_backend python /app/promote_admin.py --site-id <YOUR_SITE_ID>
			```

1) OpenAPI 최신 반영 확인
- 컨테이너 내부에서 OpenAPI 재수출 후 파일 확인
	- PowerShell
		```powershell
		docker exec cc_backend python -m app.export_openapi
		docker exec cc_backend cmd /c type current_openapi.json | powershell -Command "$input | Select-String 'admin/notifications' -SimpleMatch"
		docker exec cc_backend cmd /c type current_openapi.json | powershell -Command "$input | Select-String 'rewards/grant-bulk' -SimpleMatch"
		```

2) WebSocket 연결 확인 (/ws/notifications/{user_id})
- 브라우저 콘솔에서 간단 테스트 (F12 → Console)
	```javascript
	const uid = 1; // 연결하려는 사용자 ID
	const ws = new WebSocket(`ws://localhost:8000/ws/notifications/${uid}`);
	ws.onmessage = (e) => console.log('WS message:', e.data);
	ws.onopen = () => console.log('WS connected');
	ws.onclose = () => console.log('WS closed');
	```

3) Broadcast 알림 테스트
- 모든 연결 사용자에게 브로드캐스트
	- PowerShell (관리자 토큰 필요 시 헤더 추가)
		```powershell
		$body = @{ title = 'Maintenance'; body = 'Starts 2am'; data = @{ reason = 'routine' } } | ConvertTo-Json
		Invoke-RestMethod -Method Post -Uri "http://localhost:8000/api/admin/notifications/broadcast" -ContentType 'application/json' -Body $body # -Headers @{ Authorization = 'Bearer <ADMIN_JWT>' }
		```
- 브라우저 콘솔에서 WS 수신 로그 확인: type=ADMIN_BROADCAST 페이로드가 출력되어야 함

4) Targeted 알림 테스트
- 특정 사용자에게만 발송
	- PowerShell
		```powershell
		$body = @{ title = 'Hi'; body = 'Personal message'; user_id = 1; data = @{ note = 'vip' } } | ConvertTo-Json
		Invoke-RestMethod -Method Post -Uri "http://localhost:8000/api/admin/notifications/send" -ContentType 'application/json' -Body $body # -Headers @{ Authorization = 'Bearer <ADMIN_JWT>' }
		```
- 해당 사용자로 연결된 WS 콘솔에서 type=ADMIN_NOTIFICATION 메시지가 도착해야 함

5) 보상 대량지급 테스트 (grant-bulk)
- 여러 사용자에게 보상 지급 결과 확인
	- PowerShell
		```powershell
		$items = @(
			@{ user_id = 1; reward_type = 'TOKEN'; amount = 100; source_description = 'promo:aug' },
			@{ user_id = 99999; reward_type = 'TOKEN'; amount = 50; source_description = 'promo:aug' }
		)
		$body = @{ items = $items } | ConvertTo-Json -Depth 4
		Invoke-RestMethod -Method Post -Uri "http://localhost:8000/api/admin/rewards/grant-bulk" -ContentType 'application/json' -Body $body # -Headers @{ Authorization = 'Bearer <ADMIN_JWT>' }
		```
- 기대 결과: `results` 배열에 사용자별 {status: "ok"|"error"}가 포함. 전체 성공 시 success=true

6) 최소 Pytest 스모크 (선택)
- 컨테이너 내부 빠른 검증: 신규 엔드포인트가 2xx/4xx로 안정적으로 응답하는지 확인
	- PowerShell
		```powershell
		docker exec cc_backend pytest -q tests/test_admin_endpoints.py -q
		```

문제 발생 시 체크
- 401/403: 관리자 권한/토큰 누락 여부 확인, require_admin_access 의존성 확인
- 404: 라우터 미포함 여부(app.main 라우터 등록) 또는 경로 오타 확인
- WS 미수신: 브라우저 콘솔 에러/네트워크 탭 확인, 방화벽/프록시 영향 점검

---

Update Log (2025-08-08):
- 서버 부팅/헬스 체크 통과 (/health OK)
- OpenAPI 재생성 완료 (`backend/current_openapi.json`)
 - 루트 `cc-webapp/current_openapi.json` 제거 완료 (중복 소스 정리)
 - 컨테이너 내 smoke test (signup→login→games→rps) 통과
 - games 테이블 생성(없을 시) 및 샘플 seed 적용
 - RPS `operation_id` 고정: `games_rps_play_v1` (POST `/api/games/rps/play`)

### 추가 업데이트 (2025-08-08 오후)

- 프론트↔백엔드 스펙 동기화
	- 게임 요청 스키마에 camelCase alias 수용: betAmount, pullCount, usePremiumCurrency, autoCashout 등(Pydantic v2 alias) → 기존 FE 호출 그대로 정상 처리
	- 인증 리프레시 계약 일치: 백엔드 `/api/auth/refresh`가 이제 Authorization Bearer와 JSON body `{ refresh_token }` 모두 지원, 응답에 refresh_token 포함(호환 저장)
	- 크래시 현금화 엔드포인트 구현: `POST /api/games/crash/cashout` (요청 `{ gameId }`) 추가. 현재는 심플 시뮬레이션 로직(상태 없는 배당)으로 동작. 추후 세션 상태 기반 계산으로 교체 예정
	- FE 토큰 스토리지 보강: `cc_auth_tokens`(단일 키)와 레거시 `access_token`/`refresh_token` 양쪽을 읽고 저장/삭제 동기화(자동 마이그레이션)

- 문서/도구
	- OpenAPI 재수출 필요 시 `python -m app.export_openapi`로 갱신 가능 (컨테이너 내부)

- 유의사항
	- Crash cashout은 현재 임시 시뮬레이션이며, 실제 프로덕션 전 세션 추적/정산 로직으로 교체 필요

---

## 9. Actionable TODOs (2025-08-08)

- [ ] OpenAPI 재수출 후 커밋(프론트/문서 반영)
- [ ] 프론트 레거시 API 클라이언트(`frontend/utils/api.ts`) 제거 또는 `/api` 프리픽스 및 리프레시 계약과 일치하도록 정렬
- [ ] 워크스페이스 루트 `package.json` scripts 중복 정리/병합(dev/build/lint/storybook 통합)
- [ ] Crash 게임 세션 상태 관리(진행 중 게임, 베팅액, 배율) 및 캐시아웃 정산 로직 구현(DB 또는 Redis 세션)
- [ ] 사용자 통계 타입(`frontend/types/*`)과 백엔드 응답 스키마 일치화(누락 필드/네이밍 확인)
- [ ] 프론트 WebSocket 클라이언트 추가(`/ws/notifications/{user_id}` 연결, 토큰 인증/재연결 처리)
- [ ] 백엔드 테스트: `/api/auth/refresh`(body/Authorization 양경로) 및 `/api/games/crash/cashout` 단위/통합 테스트 추가(pytest)
- [ ] 프론트 테스트: apiClient 401→refresh→재시도 시나리오 테스트(Jest/RTL)
- [ ] 문서 갱신: 인증 리프레시 계약, 게임 API(특히 crash cashout) 스펙, 토큰 저장 정책(신규/레거시 호환)
- [ ] docker-compose 헬스체크 점검(backend 8000, frontend 3000, db/redis 등)
- [ ] Alembic 마이그레이션 정식화(게임/액션/보상 테이블), 시드 스크립트 정리

---

## 10. Admin 기능 커버리지 및 보완 계획 (2025-08-08)

### 커버리지 요약

- User info
	- 보유: GET /api/admin/stats, AdminService(list_users/get_user_details/get_user_activities/get_user_rewards)
	- 미비: 사용자 목록/상세/활동/보상 조회용 Admin 엔드포인트

- Rewards(보상)
	- 보유: POST /api/rewards/distribute, GET /api/rewards/users/{id}/rewards
	- 미비: 대량지급, 보상 취소, 템플릿 CRUD

- Events
	- 보유(사용자 플로우): 이벤트 조회/참여/진행/수령
	- 미비(관리자 CRUD): 리스트/생성/수정/삭제/퍼블리시, 미션 정의 CRUD

- Notifications(알림)
	- 보유: WS 인프라(/ws/notifications/{user_id})
	- 미비: Admin 발송/브로드캐스트/스케줄 API

- User edit(편집/계정관리)
	- 보유: ban/unban, tokens/add
	- 미비: PATCH 편집, 기타 통화(gems/gold), 균형 설정, 비번리셋, 어덜트 잠금해제

- Security/Anomaly(보안/이상탐지)
	- 보유: 세그먼트/트래킹/분석 기반(기초)
	- 미비: 이상목록/수동 플래그/룰 조회·수정/쿨다운 조치

### 제안 엔드포인트(최소 계약)

- GET /api/admin/users?search=&page=&page_size=
- GET /api/admin/users/{id}
- GET /api/admin/users/{id}/activities?page=&page_size=
- PATCH /api/admin/users/{id}
- POST /api/admin/rewards/grant-bulk
- Admin Events CRUD: POST/PUT/DELETE /api/admin/events, POST /api/admin/events/{id}/publish
- Admin Notifications: POST /api/admin/notifications/send, POST /api/admin/notifications/broadcast

### 구현 우선순위

1) Admin 사용자 목록/상세/편집
2) Admin Events CRUD (+ 미션 템플릿이 필요하면 이어서)
3) Admin Notifications 발송/브로드캐스트
4) Rewards 대량지급/템플릿
5) Security/Anomaly 패널용 기초 API

