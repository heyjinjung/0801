# Casino-Club F2P 통합/정비 가이드 (2025-08-08)

## 1. 현황 및 문제 요약

- **중복 파일 다수**: `_simple`, `_fixed`, `_temp`, `_direct`, `_v2` 등 접미사로 분기된 파일이 많아 유지보수 혼란.
- **API 라우터 중복/불일치**: games, game_api, game_api_v2 등 유사 기능이 여러 파일에 분산되어 일관성 저하.
- **환경/설정 파일 중복**: config.py, config_simple.py 등 환경설정이 분리되어 통합 배포/운영에 문제.
- **풀스택 연결 오류**: 프론트-백엔드, DB, 인증 등 연결이 불안정하거나 일부 경로가 동작하지 않음.

---

- **단일 진입점/단일 소스 유지**: 동일 목적의 파일은 하나만 남기고, 개선점은 통합.
- **모듈별 책임 명확화**: 인증, 게임, 유저, 관리 등 도메인별로 라우터/서비스/스키마 분리.
- **환경설정 일원화**: config.py 하나로 통합, .env 사용 권장.
- **API 스펙/문서 자동화**: OpenAPI/Swagger 기반 문서 자동 생성.
- **테스트/배포 자동화**: 통합 테스트, CI/CD 파이프라인 구축.


## 3. 단계별 통합/정비 체크리스트

### 1) 중복 파일 정리
- [x] *_simple.py, *_fixed.py, *_temp.py, *_direct.py, *_v2.py 등 불필요 파일 삭제
- [x] config.py, dependencies.py 등 환경/의존성 파일 단일화

- [x] games.py에 game_api, game_api_v2 기능 병합
- [x] auth.py에 simple/clean/temp 기능 병합
- [x] OpenAPI 스펙 재생성 및 문서화 (파일: `cc-webapp/backend/current_openapi.json`)

### 3) 환경설정/배포 통합
- [x] CI/CD 파이프라인 구축 (GitHub Actions)
	- 워크플로우: `.github/workflows/ci.yml`
	- 작업: frontend-tests(타입체크+Jest), backend-tests(서비스 기동+스모크/pytest)
---

## 4. 베스트 프랙티스 & 주의사항

- **모든 통합/삭제 작업 전 git backup 브랜치 생성**
- **API 변경 시 프론트엔드/문서/테스트 코드 동시 수정**
- **불필요한 주석/코드/파일은 즉시 제거**
- **문서(README, API docs) 최신 상태 유지**
---

## 5. 참고 문서
- file-comparison-report.md
- README-SIMPLE.md


## 6. 빠른 점검용 체크리스트 (복붙용)

 - [x] 핵심 라우터/서비스/스키마만 남겼는지 확인
- [ ] config.py/.env만 남기고 환경설정 통일
- [x] API 문서/스펙 최신화 (OpenAPI 갱신 및 경로 표준화)
- [ ] 전체 테스트 통과
- [ ] git commit/backup 완료

---

 - 중복 파일 정리: 루트 `cc-webapp/current_openapi.json` 제거 완료
- 생성 방식: 컨테이너 내부에서 `python -m app.export_openapi` 실행 시 자동 갱신

## 8. Next Steps

 - Admin: Added bulk rewards grant endpoint
  - POST /api/admin/rewards/grant-bulk (per-user result with ok/error)

- Crash DB persistence strict mode: Set environment variable `CRASH_DB_STRICT=1` to fail-fast when DB insert/update fails during crash session `start_session` or `cashout`. Default remains best-effort (non-strict) for local dev. Location: `app/services/crash_session.py`.
- Admin audit endpoint: New `GET /api/admin/crash/sessions` to list recent crash sessions with optional filters `user_id`, `status`, and `limit` (default 50). Secured by admin auth. Useful for live ops verification and reconciliation.
- OpenAPI tag de-duplication: Normalized tags in `rewards` router and removed redundant tag overrides in `main.py` for `rewards` and `games` routers to avoid duplicate sections in `/docs`.
- CI gating switch: Backend crash tests can be made blocking by setting `CI_CRASH_BLOCKING=1` in the CI environment. Without it, the tests run in soft-fail mode to reduce friction during stabilization.

Verification
- Start a crash bet then call `GET /api/games/crash/debug/current` to verify session visibility; cash out and confirm row update in `crash_sessions` when strict mode is enabled.
- As an admin, call `GET /api/admin/crash/sessions?limit=10` and with filters (e.g., `&status=cashed`) to inspect latest sessions.
- Open `/docs` and confirm there is a single section for Rewards/Games.
 - OpenAPI: Exported latest schema (backend/current_openapi.json) reflecting new endpoints.

### 8.1 검증 가이드 (Admin 신규 엔드포인트/WS)

사전 준비
- 백엔드·DB 컨테이너 기동 상태 확인 (http://localhost:8000/health = 200)
- 테스트용 관리자 계정 준비(권장): 기존 계정을 관리자 승격하거나 관리자 토큰 사용
	- (선택) 관리자 승격 예시: 컨테이너 내부 스크립트 활용
		- PowerShell
			```powershell
			docker exec cc_backend python /app/promote_admin.py --site-id <YOUR_SITE_ID>
			```

1) OpenAPI 최신 반영 확인
- 컨테이너 내부에서 OpenAPI 재수출 후 파일 확인
	- PowerShell
		```powershell
		docker exec cc_backend python -m app.export_openapi
		docker exec cc_backend cmd /c type current_openapi.json | powershell -Command "$input | Select-String 'admin/notifications' -SimpleMatch"
		docker exec cc_backend cmd /c type current_openapi.json | powershell -Command "$input | Select-String 'rewards/grant-bulk' -SimpleMatch"
		```

2) WebSocket 연결 확인 (/ws/notifications/{user_id})
- 브라우저 콘솔에서 간단 테스트 (F12 → Console)
	```javascript
	const uid = 1; // 연결하려는 사용자 ID
	const ws = new WebSocket(`ws://localhost:8000/ws/notifications/${uid}`);
	ws.onmessage = (e) => console.log('WS message:', e.data);
	ws.onopen = () => console.log('WS connected');
	ws.onclose = () => console.log('WS closed');
	```

3) Broadcast 알림 테스트
- 모든 연결 사용자에게 브로드캐스트
	- PowerShell (관리자 토큰 필요 시 헤더 추가)
		```powershell
		$body = @{ title = 'Maintenance'; body = 'Starts 2am'; data = @{ reason = 'routine' } } | ConvertTo-Json
		Invoke-RestMethod -Method Post -Uri "http://localhost:8000/api/admin/notifications/broadcast" -ContentType 'application/json' -Body $body # -Headers @{ Authorization = 'Bearer <ADMIN_JWT>' }
		```
- 브라우저 콘솔에서 WS 수신 로그 확인: type=ADMIN_BROADCAST 페이로드가 출력되어야 함

4) Targeted 알림 테스트
- 특정 사용자에게만 발송
	- PowerShell
		```powershell
		$body = @{ title = 'Hi'; body = 'Personal message'; user_id = 1; data = @{ note = 'vip' } } | ConvertTo-Json
		Invoke-RestMethod -Method Post -Uri "http://localhost:8000/api/admin/notifications/send" -ContentType 'application/json' -Body $body # -Headers @{ Authorization = 'Bearer <ADMIN_JWT>' }
		```
- 해당 사용자로 연결된 WS 콘솔에서 type=ADMIN_NOTIFICATION 메시지가 도착해야 함

5) 보상 대량지급 테스트 (grant-bulk)
- 여러 사용자에게 보상 지급 결과 확인
	- PowerShell
		```powershell
		$items = @(
			@{ user_id = 1; reward_type = 'TOKEN'; amount = 100; source_description = 'promo:aug' },
			@{ user_id = 99999; reward_type = 'TOKEN'; amount = 50; source_description = 'promo:aug' }
		)
		$body = @{ items = $items } | ConvertTo-Json -Depth 4
		Invoke-RestMethod -Method Post -Uri "http://localhost:8000/api/admin/rewards/grant-bulk" -ContentType 'application/json' -Body $body # -Headers @{ Authorization = 'Bearer <ADMIN_JWT>' }
		```
- 기대 결과: `results` 배열에 사용자별 {status: "ok"|"error"}가 포함. 전체 성공 시 success=true

6) 최소 Pytest 스모크 (선택)
- 컨테이너 내부 빠른 검증: 신규 엔드포인트가 2xx/4xx로 안정적으로 응답하는지 확인
	- PowerShell
		```powershell
		docker exec cc_backend pytest -q tests/test_admin_endpoints.py -q
		```

문제 발생 시 체크
- 401/403: 관리자 권한/토큰 누락 여부 확인, require_admin_access 의존성 확인
- 404: 라우터 미포함 여부(app.main 라우터 등록) 또는 경로 오타 확인
- WS 미수신: 브라우저 콘솔 에러/네트워크 탭 확인, 방화벽/프록시 영향 점검

---

### 8.2 라우터/오픈API 동기화 트러블슈팅

증상: 신규 Admin 엔드포인트가 OpenAPI(`current_openapi.json`)에 나타나지 않거나 404 발생.

원인 후보
- OpenAPI 스키마 캐시(app.openapi_schema) 미무효화
- 백엔드 프로세스 미재기동(코드 로드 타이밍 문제)
- 라우터 미등록(app.main에서 include_router 누락) 또는 경로 프리픽스 상이
- 중복 파일/경로로 잘못된 모듈이 import됨(예: admin.py가 2개 이상 존재)

권장 점검 순서 (PowerShell)
1) 스키마 캐시 무효화 후 재수출
	```powershell
	docker exec cc_backend python -m app.export_openapi
	docker exec cc_backend cmd /c type current_openapi.json | powershell -Command "$input | Select-String 'admin/notifications' -SimpleMatch"
	docker exec cc_backend cmd /c type current_openapi.json | powershell -Command "$input | Select-String 'rewards/grant-bulk' -SimpleMatch"
	```
2) 백엔드 컨테이너 재시작(프로세스/모듈 리로드 강제)
	```powershell
	docker restart cc_backend
	docker exec cc_backend python -m app.export_openapi
	docker exec cc_backend python -c "from app.main import app; app.openapi_schema=None; s=app.openapi(); import json; print(json.dumps([p for p in s['paths'].keys() if p.startswith('/api/admin/')]))"
	```
3) 라우터 등록/모듈 경로 확인
	```powershell
	# app.main에 admin 라우터가 포함되어 있는지 실행 시점 스냅샷
	docker exec cc_backend python - << 'PY'
from app.main import app
from importlib import import_module
import json

app.openapi_schema=None
s = app.openapi()
admin_paths = sorted([p for p in s['paths'].keys() if p.startswith('/api/admin/')])
print('ADMIN_PATHS=', json.dumps(admin_paths))

# admin 라우터 실제 파일 경로 추적
admin_mod = import_module('app.routers.admin')
print('ADMIN_MODULE_FILE=', getattr(admin_mod, '__file__', 'n/a'))
PY
	```
	- ADMIN_MODULE_FILE가 기대 경로(`/app/app/routers/admin.py`)가 아니면 잘못된 모듈이 로드되고 있는 것.

4) 흔한 실수/해결
	- export_openapi에 `app.openapi_schema = None` 누락 → 스키마에 신규 경로 미반영
	- uvicorn --reload 미사용 환경에서 코드만 바뀌고 프로세스는 유지 → 컨테이너 재시작 필요
	- 동일 이름 파일이 다른 폴더에 존재 → import 우선순위에 의해 과거 파일 로드됨 → 불필요 파일 제거/경로 정리

메모
- 루트의 구(旧) `cc-webapp/current_openapi.json`는 제거 완료. 기준 파일은 컨테이너 내에서 수출된 `current_openapi.json`임.
- OpenAPI 수출 스크립트는 캐시 무효화 로직을 포함함. 그래도 반영이 없으면 컨테이너 프로세스를 재기동.

### 8.3 Crash 세션 상태 및 검증 (신규)

개요
- Crash 게임이 Redis 기반 상태ful 세션으로 동작합니다.
- 단일 활성 세션 가드(중복 베팅 차단), TTL 기반 만료, profit-only 정산(베팅 원금은 선차감) 정책을 적용했습니다.
- 주요 아티팩트
	- 서비스: `cc-webapp/backend/app/services/crash_session.py`
	- 라우터 연동: `cc-webapp/backend/app/routers/games.py` (bet/cashout)
	- Alembic 초안: `cc-webapp/backend/alembic/versions/20250808_add_crash_tables.py`
	- 참조 SQL: `data/init/010_crash_sessions.sql`
	- BE 테스트: `cc-webapp/backend/app/tests/test_crash_session_lifecycle.py`
	- FE 스모크 페이지: `cc-webapp/frontend/app/api/smoke-refresh/page.tsx`

엔드포인트 요약
- POST `/api/games/crash/bet` → 세션 시작, 응답에 `game_id`(=session_id)
- POST `/api/games/crash/cashout` → 활성 세션 현금화, 이익만 가산

오류 코드
- 409: 활성 세션이 이미 존재(중복 베팅)
- 404: 현금화 시 활성 세션 없음
- 503: 세션 저장소(예: Redis) 사용 불가

검증(요약)
- bet 호출로 `game_id` 수신 → 동일 토큰으로 cashout 호출 → 잔액이 profit 만큼 증가하는지 확인
- 활성 세션 상태에서 bet 재호출 시 409 반환 확인
- cashout 후 같은 세션 재-cashout 시 404 반환 확인

Update Log (2025-08-08):
- 서버 부팅/헬스 체크 통과 (/health OK)
- OpenAPI 재생성 완료 (`backend/current_openapi.json`)
 - 루트 `cc-webapp/current_openapi.json` 제거 완료 (중복 소스 정리)
 - 컨테이너 내 smoke test (signup→login→games→rps) 통과
 - games 테이블 생성(없을 시) 및 샘플 seed 적용
 - RPS `operation_id` 고정: `games_rps_play_v1` (POST `/api/games/rps/play`)
 - Admin 미션 CRUD 경로 확인: `/api/admin/missions/`, `/api/admin/missions/{mission_id}`, `/api/admin/missions/{mission_id}/activate`가 OpenAPI에 반영됨
 - Frontend API 클라이언트 정렬: 모든 엔드포인트 `/api` 프리픽스 강제, 토큰 저장 `cc_auth_tokens`로 통합(레거시 키 동기화), 리프레시 응답 키 변형 대응
 - Compose 헬스체크: frontend(3000) 추가, backend(8000/health) 유지
 - Pytest 스모크 추가: auth refresh(헤더/바디)와 crash cashout(기본 검증) 비정상 5xx 방지 확인용
 - WS 클라이언트 개선: tokenProvider 지원, NEXT_PUBLIC_API_URL 기반 ws/wss 자동 선택, heartbeat ping(기본 30s)
 - 루트 스크립트 정리: Storybook(dev/build) 및 test:backend:smoke 스크립트 추가
 - CI 워크플로우 신설: `.github/workflows/ci.yml`(frontend-tests, backend-tests)
 - FE Jest 테스트 추가: `cc-webapp/frontend/__tests__/api.refresh.test.ts` (401→refresh→retry 성공/실패 경로)
 - Crash 세션 상태 통합: bet/cashout이 Redis-backed `CrashSessionService`로 동작(단일 활성, TTL, profit-only)
 - Alembic 초안 커밋: `alembic/versions/20250808_add_crash_tables.py`
 - BE 크래시 라이프사이클 테스트: `app/tests/test_crash_session_lifecycle.py` (토큰 제공 시 실행)
 - FE 스모크 페이지: `/api/smoke-refresh` 추가(토큰 자동 리프레시 플로우 확인)

### 추가 업데이트 (2025-08-08 오후)

- 프론트↔백엔드 스펙 동기화
	- 게임 요청 스키마에 camelCase alias 수용: betAmount, pullCount, usePremiumCurrency, autoCashout 등(Pydantic v2 alias) → 기존 FE 호출 그대로 정상 처리
	- 인증 리프레시 계약 일치: 백엔드 `/api/auth/refresh`가 이제 Authorization Bearer와 JSON body `{ refresh_token }` 모두 지원, 응답에 refresh_token 포함(호환 저장)
	- 크래시 현금화 엔드포인트 고도화: `POST /api/games/crash/cashout` (요청 `{ gameId }`)이 Redis 세션 기반으로 동작. 단일 활성 세션 가드 및 profit-only 정산 적용
	- FE 토큰 스토리지 보강: `cc_auth_tokens`(단일 키)와 레거시 `access_token`/`refresh_token` 양쪽을 읽고 저장/삭제 동기화(자동 마이그레이션)

- 문서/도구
	- OpenAPI 재수출 필요 시 `python -m app.export_openapi`로 갱신 가능 (컨테이너 내부)

- 유의사항
	- Crash 세션은 Redis 기반으로 동작합니다. DB 영속화/감사 테이블은 Alembic 정식화 후 확장 예정

---

## 9. Actionable TODOs (2025-08-08)

 - [x] OpenAPI 재수출 후 커밋(프론트/문서 반영)
 - [x] 프론트 레거시 API 클라이언트(`frontend/utils/api.ts`) `/api` 프리픽스 및 리프레시 계약 정렬, 토큰 저장 통합(`cc_auth_tokens`)
 - [x] 워크스페이스 루트 `package.json` scripts 중복 정리/병합(dev/build/lint/storybook 통합)
 - [x] Crash 게임 세션 상태 관리 1단계(진행 중 게임, 베팅액, 배율) 및 캐시아웃 정산 로직(Profit-only) 구현
	 - 완료: Redis 기반 `app/services/crash_session.py` (start/get/update_multiplier/cashout/expire)
	 - 완료: 라우터 연동 `/api/games/crash/bet`, `/api/games/crash/cashout`
	 - 진행: SQL 스케치 `data/init/010_crash_sessions.sql` (crash_sessions / crash_bets)
 - [ ] Crash 세션 DB 영속화 및 Alembic 정식화(모델 정합/제약/인덱스)
 - [ ] 사용자 통계 타입(`frontend/types/*`)과 백엔드 응답 스키마 일치화(누락 필드/네이밍 확인)
 - [x] 프론트 WebSocket 클라이언트 추가(`/ws/notifications/{user_id}` 연결, 토큰 인증/재연결 처리)
 	- 개선: `frontend/utils/wsClient.ts` (자동 재연결/지수 백오프/토큰 쿼리 지원 + tokenProvider + ws/wss 자동 + heartbeat)
 - [x] 백엔드 테스트: `/api/auth/refresh`(body/Authorization 양경로) 및 `/api/games/crash/cashout` 스모크 추가(pytest)
 - [x] 프론트 테스트: apiClient 401→refresh→재시도 시나리오 테스트(Jest/RTL)
 - [x] 문서 갱신: 인증 리프레시 계약, 게임 API(crash bet/cashout) 스펙, 토큰 저장 정책(신규/레거시 호환)
 - [x] CI/CD 파이프라인 설정(프론트/백엔드 테스트 잡 구분)
 - [x] docker-compose 헬스체크 점검(backend 8000, frontend 3000)
 - [ ] Alembic 마이그레이션 정식화(게임/액션/보상 테이블), 시드 스크립트 정리

---

## 10. Admin 기능 커버리지 및 보완 계획 (2025-08-08)

### 커버리지 요약

- User info
	- 보유: GET /api/admin/stats, AdminService(list_users/get_user_details/get_user_activities/get_user_rewards)
	- 미비: 사용자 목록/상세/활동/보상 조회용 Admin 엔드포인트

- Rewards(보상)
	- 보유: POST /api/rewards/distribute, GET /api/rewards/users/{id}/rewards
	- 미비: 대량지급, 보상 취소, 템플릿 CRUD

- Events
	- 보유(사용자 플로우): 이벤트 조회/참여/진행/수령
	- 미비(관리자 CRUD): 리스트/생성/수정/삭제/퍼블리시, 미션 정의 CRUD

- Notifications(알림)
	- 보유: WS 인프라(/ws/notifications/{user_id})
	- 미비: Admin 발송/브로드캐스트/스케줄 API

- User edit(편집/계정관리)
	- 보유: ban/unban, tokens/add
	- 미비: PATCH 편집, 기타 통화(gems/gold), 균형 설정, 비번리셋, 어덜트 잠금해제

- Security/Anomaly(보안/이상탐지)
	- 보유: 세그먼트/트래킹/분석 기반(기초)
	- 미비: 이상목록/수동 플래그/룰 조회·수정/쿨다운 조치

### 제안 엔드포인트(최소 계약)

- GET /api/admin/users?search=&page=&page_size=
- GET /api/admin/users/{id}
- GET /api/admin/users/{id}/activities?page=&page_size=
- PATCH /api/admin/users/{id}
- POST /api/admin/rewards/grant-bulk
- Admin Events CRUD: POST/PUT/DELETE /api/admin/events, POST /api/admin/events/{id}/publish
- Admin Notifications: POST /api/admin/notifications/send, POST /api/admin/notifications/broadcast

### 구현 우선순위

1) Admin 사용자 목록/상세/편집
2) Admin Events CRUD (+ 미션 템플릿이 필요하면 이어서)
3) Admin Notifications 발송/브로드캐스트
4) Rewards 대량지급/템플릿
5) Security/Anomaly 패널용 기초 API

---

추가 업데이트 (Crash persistence & debug)

- Crash 세션 DB 영속화(초기):
	- bet 시 crash_sessions에 active row 생성(external_session_id, user_id, game_id, bet_amount)
	- cashout 시 해당 row 업데이트(status=cashed, cashout_multiplier, payout_amount, cashed_out_at)
- 디버그 엔드포인트 추가: GET /api/games/crash/debug/current
	- 응답: { available: bool, session: object|null }
	- 현재 사용자 범위에서 Redis 세션 상태 확인용 (개발/QA 전용)
- 검증 팁:
	- bet → debug에서 session 확인 → cashout → debug에서 세션 없음 확인
	- DB의 crash_sessions 테이블에서 external_session_id가 응답의 game_id와 일치하는지 확인

	---

	## 11. 따라하기 체크리스트 (실행 가이드)

	아래 순서로 수행하면 로컬에서 빠르게 전체 흐름을 검증할 수 있습니다.

	1) 컨테이너/서비스 기동
	- Docker Compose로 백엔드/DB/Redis를 실행합니다. (프로젝트 루트)
	- PowerShell
		```powershell
		.\docker-manage.ps1 start --tools
		.\docker-manage.ps1 status
		```

	2) 마이그레이션 & 시드
	- Alembic 마이그레이션을 적용합니다. (컨테이너 내부 또는 편의 스크립트 사용)
	- 기본 게임 시드(`data/init/015_seed_games.sql`)를 적용합니다.
	- PowerShell (예시)
		```powershell
		# 마이그레이션
		docker exec cc_backend alembic upgrade head

		# 시드 (psql 사용 예시: 컨테이너/로컬 환경에 맞게 조정)
		docker exec -i cc_postgres psql -U cc_user -d cc_webapp -f /data/init/015_seed_games.sql
		```

	3) OpenAPI 갱신 확인 (선택)
	- 스키마 캐시 무효화 후 재수출하고, 신규 경로 반영을 점검합니다.
	- PowerShell
		```powershell
		docker exec cc_backend python -m app.export_openapi
		docker exec cc_backend cmd /c type current_openapi.json | powershell -Command "$input | Select-String 'admin/crash/sessions' -SimpleMatch"
		```

	4) 관리자 점검
	- Admin Crash Audit: `GET /api/admin/crash/sessions?limit=10`
	- Rewards Bulk: `POST /api/admin/rewards/grant-bulk`
	- WS Broadcast: `POST /api/admin/notifications/broadcast`

	5) 크래시 흐름 스모크
	- (사용자 토큰으로) `POST /api/games/crash/bet` → `GET /api/games/crash/debug/current` → `POST /api/games/crash/cashout`
	- 엄격 모드 필요 시: 백엔드 환경변수 `CRASH_DB_STRICT=1`

	6) 테스트 실행
	- 백엔드: 스모크/크래시/리프레시 테스트 (CI와 동일 구성)
	- PowerShell
		```powershell
		docker exec cc_backend pytest -q app/tests/test_auth.py -q || $true
		docker exec cc_backend pytest -q app/tests/test_crash_edge_cases.py -q || $true
		docker exec cc_backend pytest -q app/tests/test_crash_session_lifecycle.py -q || $true
		```

	7) CI 차단 스위치 (선택)
	- 크래시 관련 테스트를 차단(Blocking)하려면 파이프라인에 `CI_CRASH_BLOCKING=1` 추가

	메모
	- 로컬 개발 성능을 위해 기본은 비엄격 모드이며, 운영/스테이지에는 `CRASH_DB_STRICT=1` 권장
	- `/docs`에서 Rewards/Games 중복 섹션 여부를 확인하고, 중복 시 라우터 태그 설정을 재검토하세요

