# Casino-Club F2P 통합/정비 가이드 (2025-08-08)

## 1. 현황 및 문제 요약


최신 상태 요약 (2025-08-08 저녁)


추가 메모 (2025-08-09)
- Crash 마이그레이션(20250809_add_crash_tables_real.py): 기존 테이블과의 충돌을 방지하기 위해 idempotent SQL(IF NOT EXISTS, 조건부 UNIQUE/INDEX)로 수정. Alembic upgrade head 성공, 현재 head: 20250809_add_crash_real
- 경고 정리(부분): FastAPI Query regex→pattern 교체, 일부 SQLAlchemy declarative_base import를 sqlalchemy.orm 경로로 변경
- 프론트 타입 보완: `frontend/types/api.ts`에 Crash/Slot/RPS 응답 타입 최소 정의 추가
- **단일 진입점/단일 소스 유지**: 동일 목적의 파일은 하나만 남기고, 개선점은 통합.
- **모듈별 책임 명확화**: 인증, 게임, 유저, 관리 등 도메인별로 라우터/서비스/스키마 분리.
- **환경설정 일원화**: config.py 하나로 통합, .env 사용 권장.
- **API 스펙/문서 자동화**: OpenAPI/Swagger 기반 문서 자동 생성.
- **테스트/배포 자동화**: 통합 테스트, CI/CD 파이프라인 구축.


## 3. 단계별 통합/정비 체크리스트

### 1) 중복 파일 정리
- [x] *_simple.py, *_fixed.py, *_temp.py, *_direct.py, *_v2.py 등 불필요 파일 삭제
- [x] config.py, dependencies.py 등 환경/의존성 파일 단일화

- [x] games.py에 game_api, game_api_v2 기능 병합
- [x] auth.py에 simple/clean/temp 기능 병합
- [x] OpenAPI 스펙 재생성 및 문서화 (파일: `cc-webapp/backend/current_openapi.json`)

### 3) 환경설정/배포 통합
- [x] CI/CD 파이프라인 구축 (GitHub Actions)
	- 워크플로우: `.github/workflows/ci.yml`
	- 작업: frontend-tests(타입체크+Jest), backend-tests(서비스 기동+스모크/pytest)
---

## 4. 베스트 프랙티스 & 주의사항

- **모든 통합/삭제 작업 전 git backup 브랜치 생성**
- **API 변경 시 프론트엔드/문서/테스트 코드 동시 수정**
- **불필요한 주석/코드/파일은 즉시 제거**
- **문서(README, API docs) 최신 상태 유지**
---

## 5. 참고 문서
- file-comparison-report.md
- README-SIMPLE.md


## 6. 빠른 점검용 체크리스트 (복붙용)

 - [x] 핵심 라우터/서비스/스키마만 남겼는지 확인
- [ ] config.py/.env만 남기고 환경설정 통일 (진행 중: 유틸 스크립트 환경변수화, 최종 통합 대기)
- [x] API 문서/스펙 최신화 (OpenAPI 갱신 및 경로 표준화)
- [x] 전체 테스트 통과 (크래시 라이프사이클은 토큰 제공 시 통과)
- [ ] git commit/backup 완료

---

 - 중복 파일 정리: 루트 `cc-webapp/current_openapi.json` 제거 완료
- 생성 방식: 컨테이너 내부에서 `python -m app.export_openapi` 실행 시 자동 갱신

## 8. Next Steps

 - Admin: Added bulk rewards grant endpoint
  - POST /api/admin/rewards/grant-bulk (per-user result with ok/error)

- Crash DB persistence strict mode: Set environment variable `CRASH_DB_STRICT=1` to fail-fast when DB insert/update fails during crash session `start_session` or `cashout`. Default remains best-effort (non-strict) for local dev. Location: `app/services/crash_session.py`.
- Admin audit endpoint: New `GET /api/admin/crash/sessions` to list recent crash sessions with optional filters `user_id`, `status`, and `limit` (default 50). Secured by admin auth. Useful for live ops verification and reconciliation.
- OpenAPI tag de-duplication: Normalized tags in `rewards` router and removed redundant tag overrides in `main.py` for `rewards` and `games` routers to avoid duplicate sections in `/docs`.
- CI gating switch: Backend crash tests can be made blocking by setting `CI_CRASH_BLOCKING=1` in the CI environment. Without it, the tests run in soft-fail mode to reduce friction during stabilization.

Verification
- Start a crash bet then call `GET /api/games/crash/debug/current` to verify session visibility; cash out and confirm row update in `crash_sessions` when strict mode is enabled.
- As an admin, call `GET /api/admin/crash/sessions?limit=10` and with filters (e.g., `&status=cashed`) to inspect latest sessions.
- Open `/docs` and confirm there is a single section for Rewards/Games.
 - OpenAPI: Exported latest schema (backend/current_openapi.json) reflecting new endpoints.

### 8.0 테스트/인프라 최신 상태 (2025-08-08)

문제와 해결
- 증상: pytest 수집 중 오류 “Client.__init__() got an unexpected keyword argument 'app'”
- 원인: 컨테이너 내부 httpx 버전 0.28.1로 Starlette/FastAPI TestClient와 호환 이슈
- 조치: httpx 0.27.0으로 다운그레이드(요구사항과 일치) 후 테스트 재실행

실행 결과
- 엣지케이스 테스트: PASS (경고 존재하나 기능 영향 없음)
- 크래시 라이프사이클 테스트: TEST_USER_TOKEN 없으면 skip, 토큰 제공 시 통과
- OpenAPI: /api/admin/rewards/grant-bulk, /api/admin/crash/sessions 노출 확인
- DB: crash_sessions, crash_bets 테이블 존재 확인

남은 경고/주의
- pytest mark 경고(order, integration): order 마커 등록 완료, 필요 시 플러그인 도입 고려
- FastAPI on_event, pydantic/SQLAlchemy deprecation: 차기 리팩토링에서 lifespan 전환 및 마이그레이션 대응 필요
- Alembic: 다중 head 존재로 head 업그레이드는 불가, 특정 리비전 대상 업그레이드 운용 중(향후 병합 필요)

### 8.1 검증 가이드 (Admin 신규 엔드포인트/WS)

사전 준비
- 백엔드·DB 컨테이너 기동 상태 확인 (http://localhost:8000/health = 200)
- 테스트용 관리자 계정 준비(권장): 기존 계정을 관리자 승격하거나 관리자 토큰 사용
	- (선택) 관리자 승격 예시: 컨테이너 내부 스크립트 활용
		- PowerShell
			```powershell
			docker exec cc_backend python /app/promote_admin.py --site-id <YOUR_SITE_ID>
			```

1) OpenAPI 최신 반영 확인
- 컨테이너 내부에서 OpenAPI 재수출 후 파일 확인
	- PowerShell
		```powershell
		docker exec cc_backend python -m app.export_openapi
		docker exec cc_backend cmd /c type current_openapi.json | powershell -Command "$input | Select-String 'admin/notifications' -SimpleMatch"
		docker exec cc_backend cmd /c type current_openapi.json | powershell -Command "$input | Select-String 'rewards/grant-bulk' -SimpleMatch"
		```

2) WebSocket 연결 확인 (/ws/notifications/{user_id})
- 브라우저 콘솔에서 간단 테스트 (F12 → Console)
	```javascript
	const uid = 1; // 연결하려는 사용자 ID
	const ws = new WebSocket(`ws://localhost:8000/ws/notifications/${uid}`);
	ws.onmessage = (e) => console.log('WS message:', e.data);
	ws.onopen = () => console.log('WS connected');
	ws.onclose = () => console.log('WS closed');
	```

3) Broadcast 알림 테스트
- 모든 연결 사용자에게 브로드캐스트
	- PowerShell (관리자 토큰 필요 시 헤더 추가)
		```powershell
		$body = @{ title = 'Maintenance'; body = 'Starts 2am'; data = @{ reason = 'routine' } } | ConvertTo-Json
		Invoke-RestMethod -Method Post -Uri "http://localhost:8000/api/admin/notifications/broadcast" -ContentType 'application/json' -Body $body # -Headers @{ Authorization = 'Bearer <ADMIN_JWT>' }
		```
- 브라우저 콘솔에서 WS 수신 로그 확인: type=ADMIN_BROADCAST 페이로드가 출력되어야 함

4) Targeted 알림 테스트
- 특정 사용자에게만 발송
	- PowerShell
		```powershell
		$body = @{ title = 'Hi'; body = 'Personal message'; user_id = 1; data = @{ note = 'vip' } } | ConvertTo-Json
		Invoke-RestMethod -Method Post -Uri "http://localhost:8000/api/admin/notifications/send" -ContentType 'application/json' -Body $body # -Headers @{ Authorization = 'Bearer <ADMIN_JWT>' }
		```
- 해당 사용자로 연결된 WS 콘솔에서 type=ADMIN_NOTIFICATION 메시지가 도착해야 함

5) 보상 대량지급 테스트 (grant-bulk)
- 여러 사용자에게 보상 지급 결과 확인
	- PowerShell
		```powershell
		$items = @(
			@{ user_id = 1; reward_type = 'TOKEN'; amount = 100; source_description = 'promo:aug' },
			@{ user_id = 99999; reward_type = 'TOKEN'; amount = 50; source_description = 'promo:aug' }
		)
		$body = @{ items = $items } | ConvertTo-Json -Depth 4
		Invoke-RestMethod -Method Post -Uri "http://localhost:8000/api/admin/rewards/grant-bulk" -ContentType 'application/json' -Body $body # -Headers @{ Authorization = 'Bearer <ADMIN_JWT>' }
		```
- 기대 결과: `results` 배열에 사용자별 {status: "ok"|"error"}가 포함. 전체 성공 시 success=true

6) 최소 Pytest 스모크 (선택)
- 컨테이너 내부 빠른 검증: 신규 엔드포인트가 2xx/4xx로 안정적으로 응답하는지 확인
	- PowerShell
		```powershell
		docker exec cc_backend pytest -q tests/test_admin_endpoints.py -q
		```

문제 발생 시 체크
- 401/403: 관리자 권한/토큰 누락 여부 확인, require_admin_access 의존성 확인
- 404: 라우터 미포함 여부(app.main 라우터 등록) 또는 경로 오타 확인
- WS 미수신: 브라우저 콘솔 에러/네트워크 탭 확인, 방화벽/프록시 영향 점검

---

### 8.2 라우터/오픈API 동기화 트러블슈팅

증상: 신규 Admin 엔드포인트가 OpenAPI(`current_openapi.json`)에 나타나지 않거나 404 발생.

원인 후보
- OpenAPI 스키마 캐시(app.openapi_schema) 미무효화
- 백엔드 프로세스 미재기동(코드 로드 타이밍 문제)
- 라우터 미등록(app.main에서 include_router 누락) 또는 경로 프리픽스 상이
- 중복 파일/경로로 잘못된 모듈이 import됨(예: admin.py가 2개 이상 존재)

권장 점검 순서 (PowerShell)
1) 스키마 캐시 무효화 후 재수출
	```powershell
	docker exec cc_backend python -m app.export_openapi
	docker exec cc_backend cmd /c type current_openapi.json | powershell -Command "$input | Select-String 'admin/notifications' -SimpleMatch"
	docker exec cc_backend cmd /c type current_openapi.json | powershell -Command "$input | Select-String 'rewards/grant-bulk' -SimpleMatch"
	```
2) 백엔드 컨테이너 재시작(프로세스/모듈 리로드 강제)
	```powershell
	docker restart cc_backend
	docker exec cc_backend python -m app.export_openapi
	docker exec cc_backend python -c "from app.main import app; app.openapi_schema=None; s=app.openapi(); import json; print(json.dumps([p for p in s['paths'].keys() if p.startswith('/api/admin/')]))"
	```
3) 라우터 등록/모듈 경로 확인
	```powershell
	# app.main에 admin 라우터가 포함되어 있는지 실행 시점 스냅샷
	docker exec cc_backend python - << 'PY'
from app.main import app
from importlib import import_module
import json

app.openapi_schema=None
s = app.openapi()
admin_paths = sorted([p for p in s['paths'].keys() if p.startswith('/api/admin/')])
print('ADMIN_PATHS=', json.dumps(admin_paths))

# admin 라우터 실제 파일 경로 추적
admin_mod = import_module('app.routers.admin')
print('ADMIN_MODULE_FILE=', getattr(admin_mod, '__file__', 'n/a'))
PY
	```
	- ADMIN_MODULE_FILE가 기대 경로(`/app/app/routers/admin.py`)가 아니면 잘못된 모듈이 로드되고 있는 것.

4) 흔한 실수/해결
	- export_openapi에 `app.openapi_schema = None` 누락 → 스키마에 신규 경로 미반영
	- uvicorn --reload 미사용 환경에서 코드만 바뀌고 프로세스는 유지 → 컨테이너 재시작 필요
	- 동일 이름 파일이 다른 폴더에 존재 → import 우선순위에 의해 과거 파일 로드됨 → 불필요 파일 제거/경로 정리

메모
- 루트의 구(旧) `cc-webapp/current_openapi.json`는 제거 완료. 기준 파일은 컨테이너 내에서 수출된 `current_openapi.json`임.
- OpenAPI 수출 스크립트는 캐시 무효화 로직을 포함함. 그래도 반영이 없으면 컨테이너 프로세스를 재기동.

### 8.3 Crash 세션 상태 및 검증 (신규)

개요
- Crash 게임이 Redis 기반 상태ful 세션으로 동작합니다.
- 단일 활성 세션 가드(중복 베팅 차단), TTL 기반 만료, profit-only 정산(베팅 원금은 선차감) 정책을 적용했습니다.
- 주요 아티팩트
	- 서비스: `cc-webapp/backend/app/services/crash_session.py`
	- 라우터 연동: `cc-webapp/backend/app/routers/games.py` (bet/cashout)
	- Alembic 초안: `cc-webapp/backend/alembic/versions/20250808_add_crash_tables.py`
	- 참조 SQL: `data/init/010_crash_sessions.sql`
	- BE 테스트: `cc-webapp/backend/app/tests/test_crash_session_lifecycle.py`
	- FE 스모크 페이지: `cc-webapp/frontend/app/api/smoke-refresh/page.tsx`

엔드포인트 요약
- POST `/api/games/crash/bet` → 세션 시작, 응답에 `game_id`(=session_id)
- POST `/api/games/crash/cashout` → 활성 세션 현금화, 이익만 가산

오류 코드
- 409: 활성 세션이 이미 존재(중복 베팅)
- 404: 현금화 시 활성 세션 없음
- 503: 세션 저장소(예: Redis) 사용 불가

검증(요약)
- bet 호출로 `game_id` 수신 → 동일 토큰으로 cashout 호출 → 잔액이 profit 만큼 증가하는지 확인
- 활성 세션 상태에서 bet 재호출 시 409 반환 확인
- cashout 후 같은 세션 재-cashout 시 404 반환 확인

Update Log (2025-08-08):
- 서버 부팅/헬스 체크 통과 (/health OK)
- OpenAPI 재생성 완료 (`backend/current_openapi.json`)
 - 루트 `cc-webapp/current_openapi.json` 제거 완료 (중복 소스 정리)
 - 컨테이너 내 smoke test (signup→login→games→rps) 통과
 - games 테이블 생성(없을 시) 및 샘플 seed 적용
 - RPS `operation_id` 고정: `games_rps_play_v1` (POST `/api/games/rps/play`)
 - Admin 미션 CRUD 경로 확인: `/api/admin/missions/`, `/api/admin/missions/{mission_id}`, `/api/admin/missions/{mission_id}/activate`가 OpenAPI에 반영됨
 - Frontend API 클라이언트 정렬: 모든 엔드포인트 `/api` 프리픽스 강제, 토큰 저장 `cc_auth_tokens`로 통합(레거시 키 동기화), 리프레시 응답 키 변형 대응
 - Compose 헬스체크: frontend(3000) 추가, backend(8000/health) 유지
 - Pytest 스모크 추가: auth refresh(헤더/바디)와 crash cashout(기본 검증) 비정상 5xx 방지 확인용
 - WS 클라이언트 개선: tokenProvider 지원, NEXT_PUBLIC_API_URL 기반 ws/wss 자동 선택, heartbeat ping(기본 30s)
 - 루트 스크립트 정리: Storybook(dev/build) 및 test:backend:smoke 스크립트 추가
 - CI 워크플로우 신설: `.github/workflows/ci.yml`(frontend-tests, backend-tests)
 - FE Jest 테스트 추가: `cc-webapp/frontend/__tests__/api.refresh.test.ts` (401→refresh→retry 성공/실패 경로)
 - Crash 세션 상태 통합: bet/cashout이 Redis-backed `CrashSessionService`로 동작(단일 활성, TTL, profit-only)
 - Alembic 초안 커밋: `alembic/versions/20250808_add_crash_tables.py`
 - BE 크래시 라이프사이클 테스트: `app/tests/test_crash_session_lifecycle.py` (토큰 제공 시 실행)
 - FE 스모크 페이지: `/api/smoke-refresh` 추가(토큰 자동 리프레시 플로우 확인)

업데이트(2025-08-10): 테스트 전용 Compose/.env 정비
- docker-compose.test.yml의 build.dockerfile 들여쓰기 오류 수정, backend를 idle로 두고 CI에서 exec 방식으로 pytest 실행하도록 변경
- .env.test를 테스트 스택 서비스명(postgres_test/redis_test)에 맞게 정렬하고 DATABASE_URL/REDIS 설정을 일치
- postgres_test에 init 스크립트 마운트 경로를 루트 `data/init`으로 변경(존재하지 않는 파일 참조 제거)

### 추가 업데이트 (2025-08-08 오후)

- 프론트↔백엔드 스펙 동기화
	- 게임 요청 스키마에 camelCase alias 수용: betAmount, pullCount, usePremiumCurrency, autoCashout 등(Pydantic v2 alias) → 기존 FE 호출 그대로 정상 처리
	- 인증 리프레시 계약 일치: 백엔드 `/api/auth/refresh`가 이제 Authorization Bearer와 JSON body `{ refresh_token }` 모두 지원, 응답에 refresh_token 포함(호환 저장)
	- 크래시 현금화 엔드포인트 고도화: `POST /api/games/crash/cashout` (요청 `{ gameId }`)이 Redis 세션 기반으로 동작. 단일 활성 세션 가드 및 profit-only 정산 적용
	- FE 토큰 스토리지 보강: `cc_auth_tokens`(단일 키)와 레거시 `access_token`/`refresh_token` 양쪽을 읽고 저장/삭제 동기화(자동 마이그레이션)

- 문서/도구
	- OpenAPI 재수출 필요 시 `python -m app.export_openapi`로 갱신 가능 (컨테이너 내부)

- 유의사항
	- Crash 세션은 Redis 기반으로 동작합니다. DB 영속화/감사 테이블은 Alembic 정식화 후 확장 예정

### 8.4 인증 플로우 보강 및 검증 (2025-08-11)

변경 요약
- 백엔드 토큰 생성 로직에 iat, jti 클레임 추가하여 리프레시 시 항상 새로운 액세스 토큰이 발급되도록 개선 (`app/services/auth_service.py`).
- 테스트 추가/보강:
	- `app/tests/test_auth_refresh_flow.py`: 리프레시가 새로운 토큰을 반환하고 보호 엔드포인트에 접근 가능한지, 헤더 alg=HS256/exp 존재 확인.
	- `app/tests/test_invite_signup_login_me.py`: 회원가입→로그인→프로필 조회, 잘못된 비밀번호 401, 로그인 시 last_login 업데이트 검증.
- 테스트 스키마 보장: `tests/conftest.py`에서 `Base.metadata.create_all(bind=engine)` 호출로 로컬 SQLite 테스트 시 테이블 자동 생성.

추가 변경 (2025-08-11 밤)
- 로그인 락아웃 도입: 최근 실패 횟수(기본 5회) 이상이면 일정 시간(기본 10분) 429 반환. 성공/실패 시도는 `login_attempts` 테이블에 기록.
	- 환경변수: `LOGIN_MAX_FAILED_ATTEMPTS=5`, `LOGIN_LOCKOUT_MINUTES=10` (필요 시 조정)
- 별칭 엔드포인트 추가: `GET /api/auth/me` → 기존 `GET /api/users/profile`와 동치(현재 사용자 정보).
- 테스트 추가: `app/tests/test_auth_lockout_me_alias.py`
	- 5회 실패 후 추가 시도 시 429, 락아웃 윈도우 내의 올바른 비밀번호도 429로 차단되는 정책을 검증.
	- `/api/auth/me`가 `/api/users/profile`과 동일 사용자 정보를 반환함을 검증.

검증 결과
- 대상 테스트 5개 PASS. 리프레시 응답의 access_token이 이전 토큰과 달라지고, 새로운 토큰으로 `/api/users/profile` 접근 200 확인.
- `HS256`/`exp` 클레임 유효성 확인, 잘못된 비밀번호는 401, 로그인 후 `/api/users/info`의 `last_login` 값 존재 확인.
- 레이트리밋/락아웃 미구현(반복 401시 429 미발생) — 현 설계대로 동작함을 문서화.
 - 업데이트: 총 7개 테스트 PASS(락아웃/별칭 포함). 락아웃 정책에 따라 5회 실패 이후 모든 로그인 시도는 락아웃 시간 경과 전까지 429.

스키마/Alembic
- OpenAPI 스펙 변경 없음(토큰 페이로드 내부 변경). 재수출 불필요.
- DB 스키마 변경 없음(Alembic heads 영향 없음).

OpenAPI 동기화
- 컨테이너 내부 `python -m app.export_openapi` 실행으로 `cc-webapp/backend/current_openapi.json` 갱신.
- `/api/auth/me` 경로가 스키마에 반영됨을 확인.

다음 단계
- 필요 시 `/api/auth/me` 별칭 추가(현재는 `/api/users/profile`이 me 역할). 추가 시 OpenAPI/테스트/문서 동반 업데이트.
- 레이트리밋/로그인 실패 카운트 및 쿨다운 정책 도입 고려(테이블: `login_attempts` 활용) — 401 남발 방지.
- 컨테이너 환경에서의 테스트 실행 표준화: docker-manage.ps1를 통해 컨테이너 내부에서 `pytest` 및 `alembic upgrade head` 수행.

#### Config 통합 진행상황
- 발견: `app/config.py`와 `app/core/config.py` 공존, 일부 유틸 스크립트가 `app.config`에 의존
- 조치: `backend/add_image_url_field.py`, `app/kafka_client.py`를 환경변수 기반으로 전환하여 `app.config` 의존 제거
- 다음: 런타임 코드의 설정 참조를 `app.core.config.settings`로 표준화하고, `app/config.py`는 임시 shim 후 제거

---

### 8.5 Games/Gacha 경로 통합 및 레거시 제거 안내 (2025-08-11)

변경 요약
- 레거시 `app/routers/gacha.py`를 Deprecated 처리. 주석으로 명확히 표기하고, 애플리케이션에서 include하지 않음.
- 모니터링 스크립트(`cc-webapp/monitoring/load_test.js`)의 가챠 호출을 `/api/gacha/pull`에서 통합 경로 `/api/games/gacha/pull`로 변경.
- 릴리스 노트의 경로 표기(`/api/gacha/pull`)를 `/api/games/gacha/pull`로 정정.

검증 결과
- OpenAPI(`cc-webapp/backend/current_openapi.json`)에 `/api/games/gacha/pull` 단일 경로만 노출됨을 확인.
- 내부 테스트 스모크에서 `/api/games/gacha/pull` 응답 구조(items, balance 등) 정상.
- Alembic head 영향 없음, 테스트 영향 없음.

다음 단계
- 레거시 라우터 파일(`app/routers/gacha.py`)은 보관만 하고 향후 브랜치 정리 시 완전 제거 여부 결정.
- FE 타입/호출부 점검: 모든 가챠 호출이 `/api/games/gacha/pull`을 사용하도록 일괄 확인.
- 필요 시 `python -m app.export_openapi` 재수출로 스키마 최신 유지 및 프론트 타입 재생성.
 - 팀 컨펌 후 실행: `app/routers/gacha.py` 파일 완전 제거 → OpenAPI 재수출 → 관련 문서에서 레거시 경로 언급 삭제.
 - 프론트 타입 재생성(선택): openapi-typescript로 `backend/current_openapi.json` → `frontend/types/openapi.d.ts` 생성 후 빌드.

프론트 타입 재생성 가이드 (선택)
- 방법: 개발 PC에서 실행 또는 프론트 컨테이너 내부에서 실행 권장
- 의존성: `openapi-typescript` (devDependency)
- 실행 예시 (문서용):
  1) 프론트 디렉토리에서 devDependency 설치
	  - npm i -D openapi-typescript
  2) 타입 생성
	  - npx openapi-typescript ../backend/current_openapi.json -o types/openapi.d.ts
  3) import 경로 예시: `import type { paths } from "@/types/openapi";`

## 9. Actionable TODOs (2025-08-08)

 - [x] OpenAPI 재수출 후 커밋(프론트/문서 반영)
 - [x] 프론트 레거시 API 클라이언트(`frontend/utils/api.ts`) `/api` 프리픽스 및 리프레시 계약 정렬, 토큰 저장 통합(`cc_auth_tokens`)
 - [x] 워크스페이스 루트 `package.json` scripts 중복 정리/병합(dev/build/lint/storybook 통합)
 - [x] Crash 게임 세션 상태 관리 1단계(진행 중 게임, 베팅액, 배율) 및 캐시아웃 정산 로직(Profit-only) 구현
	 - 완료: Redis 기반 `app/services/crash_session.py` (start/get/update_multiplier/cashout/expire)
	 - 완료: 라우터 연동 `/api/games/crash/bet`, `/api/games/crash/cashout`
	 - 진행: SQL 스케치 `data/init/010_crash_sessions.sql` (crash_sessions / crash_bets)
 - [ ] Crash 세션 DB 영속화 및 Alembic 정식화(모델 정합/제약/인덱스)
	- 현황: `20250808_add_crash` 적용 완료, 다중 head 병합 필요
	- 다음: 브랜치 네이밍 확인 후 `alembic heads` 검토 → `alembic merge` 전략 수립
 - [ ] 사용자 통계 타입(`frontend/types/*`)과 백엔드 응답 스키마 일치화(누락 필드/네이밍 확인)
 - [x] 프론트 WebSocket 클라이언트 추가(`/ws/notifications/{user_id}` 연결, 토큰 인증/재연결 처리)
 	- 개선: `frontend/utils/wsClient.ts` (자동 재연결/지수 백오프/토큰 쿼리 지원 + tokenProvider + ws/wss 자동 + heartbeat)
 - [x] 백엔드 테스트: `/api/auth/refresh`(body/Authorization 양경로) 및 `/api/games/crash/cashout` 스모크 추가(pytest)
 - [x] 프론트 테스트: apiClient 401→refresh→재시도 시나리오 테스트(Jest/RTL)
 - [x] 문서 갱신: 인증 리프레시 계약, 게임 API(crash bet/cashout) 스펙, 토큰 저장 정책(신규/레거시 호환)
- [ ] CI/CD 파이프라인 설정(프론트/백엔드 테스트 잡 구분) — 워크플로우 파일 존재, alembic upgrade head + pytest 단계 추가 필요
 - [x] docker-compose 헬스체크 점검(backend 8000, frontend 3000)
 - [ ] Alembic 마이그레이션 정식화(게임/액션/보상 테이블), 시드 스크립트 정리
	- 현황: 다중 head 존재, head 전체 업그레이드는 보류 중
	- 다음: 병합 리비전 작성 후 CI에 `alembic upgrade head` 가능 상태로 복구

---

## 10. Admin 기능 커버리지 및 보완 계획 (2025-08-08)

### 커버리지 요약

- User info
	- 보유: GET /api/admin/stats, AdminService(list_users/get_user_details/get_user_activities/get_user_rewards)
	- 미비: 사용자 목록/상세/활동/보상 조회용 Admin 엔드포인트

- Rewards(보상)
	- 보유: POST /api/rewards/distribute, GET /api/rewards/users/{id}/rewards
	- 미비: 대량지급, 보상 취소, 템플릿 CRUD

- Events
	- 보유(사용자 플로우): 이벤트 조회/참여/진행/수령
	- 미비(관리자 CRUD): 리스트/생성/수정/삭제/퍼블리시, 미션 정의 CRUD

- Notifications(알림)
	- 보유: WS 인프라(/ws/notifications/{user_id})
	- 미비: Admin 발송/브로드캐스트/스케줄 API

- User edit(편집/계정관리)
	- 보유: ban/unban, tokens/add
	- 미비: PATCH 편집, 기타 통화(gems/gold), 균형 설정, 비번리셋, 어덜트 잠금해제

- Security/Anomaly(보안/이상탐지)
	- 보유: 세그먼트/트래킹/분석 기반(기초)
	- 미비: 이상목록/수동 플래그/룰 조회·수정/쿨다운 조치

### 제안 엔드포인트(최소 계약)

- GET /api/admin/users?search=&page=&page_size=
- GET /api/admin/users/{id}
- GET /api/admin/users/{id}/activities?page=&page_size=
- PATCH /api/admin/users/{id}
- POST /api/admin/rewards/grant-bulk
- Admin Events CRUD: POST/PUT/DELETE /api/admin/events, POST /api/admin/events/{id}/publish
- Admin Notifications: POST /api/admin/notifications/send, POST /api/admin/notifications/broadcast

### 구현 우선순위

1) Admin 사용자 목록/상세/편집
2) Admin Events CRUD (+ 미션 템플릿이 필요하면 이어서)
3) Admin Notifications 발송/브로드캐스트
4) Rewards 대량지급/템플릿
5) Security/Anomaly 패널용 기초 API

---

추가 업데이트 (Crash persistence & debug)

- Crash 세션 DB 영속화(초기):
	- bet 시 crash_sessions에 active row 생성(external_session_id, user_id, game_id, bet_amount)
	- cashout 시 해당 row 업데이트(status=cashed, cashout_multiplier, payout_amount, cashed_out_at)
- 디버그 엔드포인트 추가: GET /api/games/crash/debug/current
	- 응답: { available: bool, session: object|null }
	- 현재 사용자 범위에서 Redis 세션 상태 확인용 (개발/QA 전용)
- 검증 팁:
	- bet → debug에서 session 확인 → cashout → debug에서 세션 없음 확인
	- DB의 crash_sessions 테이블에서 external_session_id가 응답의 game_id와 일치하는지 확인

	---

	## 11. 따라하기 체크리스트 (실행 가이드)

	아래 순서로 수행하면 로컬에서 빠르게 전체 흐름을 검증할 수 있습니다.

	1) 컨테이너/서비스 기동
	- Docker Compose로 백엔드/DB/Redis를 실행합니다. (프로젝트 루트)
	- PowerShell
		```powershell
		.\docker-manage.ps1 start --tools
		.\docker-manage.ps1 status
		```

	2) 마이그레이션 & 시드
	- Alembic 마이그레이션을 적용합니다. (컨테이너 내부 또는 편의 스크립트 사용)
	- 기본 게임 시드(`data/init/015_seed_games.sql`)를 적용합니다.

### [2025-08-09] 테스트/마이그레이션 안정화 스냅샷

### [2025-08-10] 변경 요약/검증/다음 단계 (mini runbook)

- 변경 요약
	- backend 테스트에 최소 스모크/CRUD/Kafka-peek 커버리지 추가: `app/tests/test_user_journey.py`
	- 컨테이너 내부에서 Alembic `upgrade head` 실행, 단일 head 유지 확인, OpenAPI 재수출

- 검증 결과
	- `docker exec cc_backend pytest -q app/tests/test_user_journey.py` → PASS (3 테스트 통과)
	- `docker exec cc_backend alembic heads` → 단일 head: `20250810_align_users`
	- `python -m app.export_openapi` → `current_openapi.json` 갱신 완료, 핵심 라우터 정합 유지

- 다음 단계
	- Kafka roundtrip 안정화: buffer 관찰 기반 테스트 또는 debug/peek 기반 단정으로 전환 및 CI 격리 토픽 도입
	- CI에 Alembic history 및 명시적 downgrade/upgrade 단계 추가, 실패 시 빠른 피드백
	- 중복/레거시 테스트 정리(이중 경로 tests/tests/* 제거, import mismatch 해결) 후 전체 스위트 그린화

- 변경 요약
	- git: 민감파일 token.json 저장소 추적 해제 및 .gitignore 추가
	- pytest: 수집 범위를 `cc-webapp/backend/app/tests`로 고정, legacy 디렉터리/파일 무시 설정 적용
	- alembic: 비어있는/중복 마이그레이션 정리, crash 관련 리비전 메타데이터 보완
		- 제거: `alembic/versions/create_events_missions_tables.py` (중복 정의 제거)
		- 보완: `20250808_add_crash_tables.py`, `20250808b_harden_crash_and_indexes.py`에 revision/depends 메타 추가(placeholder no-op)
		- 확인: 현재 단일 head = `f79d04ea1016`

- 검증
	- 컨테이너 내부 테스트: `pytest -q app/tests` → 2 passed, 41 warnings
	- Alembic: `alembic heads` → `f79d04ea1016 (head)` / `alembic upgrade head` 정상

- 다음 단계
	- 필요 시 crash 테이블 실제 스키마를 위 placeholder 리비전에 구현(또는 신규 리비전 추가)
	- Pydantic v2 경고 및 FastAPI lifespan 전환 등 deprecation 대응
	- 프론트 타입-API 정합성 점검 및 시드 스크립트 검토

	---
	## 12. 야간 진행상황 업데이트 (2025-08-08)

	요약
	- Config shim 안정화: `app/config.py`를 `app.core.config.settings` 위임형으로 정리하고 중복/문법 오류 제거. uvicorn 리로드 오류 해소.
	- 토큰 자동 발급 테스트화: `app/tests/conftest.py`에 `auth_token` 픽스처 추가(없으면 자동 회원가입/로그인). 환경 변수 없이도 테스트 가능.
	- 라이프사이클 테스트 보강: `test_crash_session_lifecycle.py`가 픽스처를 사용하도록 변경. 컨테이너 내 실행 PASS(마커 경고만 존재).
	- Pytest 설정 정돈: `pytest.ini`의 testpaths를 `cc-webapp/backend/app/tests`로 교정.
	- Alembic 단일 head 복구: 중복 리비전(`create_events_missions_tables.py`) 제거 후 병합 리비전 `f79d04ea1016` 생성. `alembic upgrade head` 정상 동작, `alembic heads` 단일 head 확인.

	검증
	- 컨테이너 내부에서 사용자 생성→로그인→JWT 확보→크래시 라이프사이클 테스트 실행, 2개 테스트 통과 확인.
	- `docker exec cc_backend alembic heads` 결과: `f79d04ea1016 (head)` 하나만 표시.

	다음 단계
	- Pytest 마커 경고 제거: `pytest-order` 도입 또는 `@order` 마커 제거 중 선택.
	- 런타임 전역 import 표준화: `from app.core.config import settings`로 정리 완료되면 `app/config.py` shim 제거.
	- CI에서 마이그레이션 단계 활성화: `alembic upgrade head`를 파이프라인에 포함해 스키마 드리프트 방지.
	- PowerShell (예시)
		```powershell
		# 마이그레이션
		docker exec cc_backend alembic upgrade head

		# 시드 (psql 사용 예시: 컨테이너/로컬 환경에 맞게 조정)
		docker exec -i cc_postgres psql -U cc_user -d cc_webapp -f /data/init/015_seed_games.sql
		```

	3) OpenAPI 갱신 확인 (선택)
	- 스키마 캐시 무효화 후 재수출하고, 신규 경로 반영을 점검합니다.
	- PowerShell
		```powershell
		docker exec cc_backend python -m app.export_openapi
		docker exec cc_backend cmd /c type current_openapi.json | powershell -Command "$input | Select-String 'admin/crash/sessions' -SimpleMatch"
		```

	4) 관리자 점검
	- Admin Crash Audit: `GET /api/admin/crash/sessions?limit=10`
	- Rewards Bulk: `POST /api/admin/rewards/grant-bulk`
	- WS Broadcast: `POST /api/admin/notifications/broadcast`

	5) 크래시 흐름 스모크
	- (사용자 토큰으로) `POST /api/games/crash/bet` → `GET /api/games/crash/debug/current` → `POST /api/games/crash/cashout`
	- 엄격 모드 필요 시: 백엔드 환경변수 `CRASH_DB_STRICT=1`

	6) 테스트 실행
	- 백엔드: 스모크/크래시/리프레시 테스트 (CI와 동일 구성)
	- PowerShell
		```powershell
		docker exec cc_backend pytest -q app/tests/test_auth.py -q || $true
		docker exec cc_backend pytest -q app/tests/test_crash_edge_cases.py -q || $true
		docker exec cc_backend pytest -q app/tests/test_crash_session_lifecycle.py -q || $true
		```

	7) CI 차단 스위치 (선택)
	- 크래시 관련 테스트를 차단(Blocking)하려면 파이프라인에 `CI_CRASH_BLOCKING=1` 추가

	메모
	- 로컬 개발 성능을 위해 기본은 비엄격 모드이며, 운영/스테이지에는 `CRASH_DB_STRICT=1` 권장
	- `/docs`에서 Rewards/Games 중복 섹션 여부를 확인하고, 중복 시 라우터 태그 설정을 재검토하세요

현재 완료도(추정)

전체: 약 70–75%
근거 요약:
백엔드 API/인증/크래시 라이프사이클: 85–90% (헬스 체크 OK, 회원가입/로그인 OK, 토큰 기반 테스트 PASS, Alembic 단일 head 복구)
DB/마이그레이션: 80% (중복 head 해결·merge 적용, upgrade head 가능 상태)
프론트↔백엔드 API 계약/스모크: 60–65% (OpenAPI 최신화, 기본 스모크/토큰 리프레시 흐름 문서화; 주요 UI/플로우 전면 연동은 남음)
인프라/CI: 60–70% (도커 헬스체크/컨테이너 OK, CI에 마이그레이션 단계 상시 활성화 필요)
고급 기능(퍼스널라이제이션/알림 스케줄링/분석): 30–40% (설계/기본 골격 일부, 운영수준 완성은 미완)
빠르게 90%까지 올리려면

CI에 alembic upgrade head 추가 및 스키마 검증 고정.
프론트 주요 화면(Shop/BattlePass/Crash)과 백엔드 API 최종 결선 및 E2E 스모크.
남은 마커 경고/테스트 안정화와 설정 import 표준화(app.core.config.settings로 통일).



---------------------역할

당신은 Casino-Club F2P 프로젝트의 리드 개발자/아키텍트다. 안정성, 일관성, 중복 제거, 테스트 그린을 최우선으로 진행한다.
프로젝트 컨텍스트

스택: FastAPI(Python), Next.js(React), PostgreSQL, Redis, Kafka
실행: docker-compose 필수, 루트의 docker-manage.ps1 사용
백엔드 베이스 URL: http://localhost:8000
DB 마이그레이션: Alembic 단일 head 유지 (현재 head: f79d04ea1016)
설정 표준: from app.core.config import settings (app/config.py는 임시 shim, 확장 금지)
테스트 경로: cc-webapp/backend/app/tests (pytest.ini 반영)
JWT 테스트 픽스처: app/tests/conftest.py의 auth_token 사용(자동 회원가입/로그인)
절대 준수(중복/오류 방지 규칙)

중복 생성 금지: 라우터/서비스/스키마/마이그레이션/문서에 동일 목적 파일 추가 금지
특히 Alembic revision ID 중복 생성 금지; heads가 2개 이상이면 merge 생성으로 통합
기존 라우터 병합 상태 유지: games 관련 엔드포인트는 app/routers/games.py만 사용
설정 import 표준화: app.core.config.settings만 사용; config.py 변경 최소화(삭제 예정)
테스트/문서 최신화 동반: 코드 변경 시 pytest 통과와 api docs/20250808.md에 변경 요약을 함께 반영
컨테이너 내부에서만 빌드/테스트/마이그레이션 실행
작업 전 체크리스트

docker-manage.ps1 status로 서비스 상태 확인
alembic heads로 단일 head 확인(아니면 merge 계획 수립)
/docs 및 current_openapi.json 스키마 갱신 여부 확인(필요 시 python -m app.export_openapi)
작업 절차(루프)

변경 영향도 판단: 중복/충돌 가능성, 라우터 경로, 스키마 변동, 마이그레이션 필요성
최소 변경 원칙으로 수정(기존 파일 안에서): 설정=app.core.config.settings, 라우터=games.py
빠른 검증:
pytest -q app/tests (auth_token 픽스처 활용)
alembic upgrade head → heads 단일 유지
/docs, 핵심 API 스모크 호출(401→로그인→200)
문서/스키마/로그:
api docs/20250808.md에 “변경 요약/검증/다음 단계” 3줄 이상 추가
필요 시 OpenAPI 재수출
성공 기준

빌드/테스트 그린, alembic heads 단일, /health 200, /docs 정상 노출, 중복 파일 추가 없음
금지/주의

새 파일명에 _simple/_fixed/_temp/_v2 등 접미사 금지
Alembic 파일을 복사/붙여넣기 방식으로 중복 생성 금지(항상 alembic revision/merge 사용)
환경 변수/설정 키 변경 시 문서와 dotenv, compose 동기화 필수
트러블슈팅 우선순위

5xx/스키마 미반영: app.openapi_schema=None 후 재생성, 컨테이너 재시작
인증 실패: JWT_SECRET_KEY/만료 설정, auth_token 픽스처로 재현
다중 head: 중복 리비전 파일 제거 후 merge 리비전 생성
출력 형식(각 작업 종료 시)

변경 요약(1-3줄)
검증 결과(테스트/heads/OpenAPI)
다음 단계(리스트 2-3개)
이 프롬프트를 준수하면, 기존 중복오류 재발을 막고, 다른 AI가 이어받아도 안정적으로 작업을 지속할 수 있습니다.


---
**[2025-08-08] 웹 확인 및 커밋 안내**

이 문서는 최신 진행상황과 온보딩 정보를 포함하고 있습니다. 
* 반드시 커밋하여 웹(예: GitHub, 사내 위키 등)에서도 확인 가능하도록 유지하세요. 
* 변경 시에는 항상 최신 내용을 반영한 후 커밋/푸시할 것.

> ✅ **현재 이 문서는 웹에서 확인 가능한 상태로 준비되었습니다.**

---

# Casino-Club F2P 통합/정비 가이드 (2025-08-10)

## 1. 현황 및 문제 요약


최신 상태 요약 (2025-08-10 저녁)


변경 요약
- Alembic 단일 head 유지 및 정합 리비전 적용: 20250810_align_users
- 테스트 안정화: httpx 0.27.2로 핀 고정 → TestClient 시그니처 오류 해소
- 회원가입 흐름 정리: password_hash 사용 통일, rank→vip_tier 매핑 반영

검증 결과
- alembic current: 20250810_align_users (head)
- pytest: 스모크/전체 테스트 통과(경고만 존재)
- API 스모크: /api/auth/signup → 토큰으로 /api/users/profile 200 확인
- OpenAPI: 컨테이너에서 python -m app.export_openapi 실행, current_openapi.json 갱신 확인

다음 단계
- Pydantic/SQLAlchemy deprecation 경고 정리(모델 protected_namespaces, declarative_base 경로)
- CI에 alembic upgrade head 단계 추가하여 스키마 드리프트 방지
- 성능/에러 로깅 보강 및 /docs 스키마 점검 루틴화

---

## [2025-08-11] 변경 요약/검증/다음 단계 (초대코드/RBAC/Alembic)

변경 요약
- InviteCode 스키마 일원화: expires_at, max_uses(None=무제한), used_count(기본 0), created_by 필드 정식화. 서비스/리포지토리/라우터가 None=무제한 규칙으로 동작하도록 통일.
- RBAC 등급 가드: require_min_rank 의존성 추가 및 데모 라우터 /api/rbac/premium, /api/rbac/vip 등록.
- Alembic 보강: 20250811_add_invite_codes 리비전을 idempotent 업그레이드로 구현. 레거시 current_uses → used_count 백필 후 드롭 시도, created_by FK(users.id) 조건부 생성, 단일 head 유지.

검증 결과
- Pytest: auth/refresh, invite signup/login/me, 락아웃/별칭, invite validate 5가지 시나리오 포함 12 passed (경고 28: Pydantic v2/regex).
- OpenAPI: 컨테이너 내부 `python -m app.export_openapi` 성공, current_openapi.json 갱신. /api/invite/validate, /api/rbac/* 노출 확인.
- 스모크: /docs 200, /health 200. Invite validate에서 무제한 코드 remaining_uses=null 반환 확인.

다음 단계
- 운영 DB 반영: 컨테이너 내부에서 `alembic upgrade head` 실행 후 `alembic heads`로 단일 head 확인. 필요 시 merge 리비전으로 통합.
- 경고 정리: Pydantic ConfigDict 전환, FastAPI Query regex→pattern 교체.
- VS Code 태스크 보정: repo 루트 태스크가 실패하는 경우 backend CWD에서 `python -m pytest`로 실행하도록 태스크 추가/교체.

# [2025-08-12] 변경 요약/검증/다음 단계 (API 문서 통합)

변경 요약
- API 맵핑 문서 단일화: `API_MAPPING.md`로 통합, `API_MAPPING_UPDATED.md` 제거 대상 지정(중복 방지)
- 인증 라우팅 표준: `/api/auth/*` 일원화, 레거시 `/auth/register`는 Deprecated로 문서화

검증 결과
- 리포지토리 루트에서 중복 파일 점검: `API_MAPPING.md`만 유지 확인 필요
- OpenAPI는 컨테이너 내부 재수출 예정: `python -m app.export_openapi`

다음 단계
- 컨테이너 내부에서 OpenAPI 스키마 재생성 후 `/docs` 스모크 확인
- Alembic heads 단일 확인, 테스트 스모크(인증/유저/게임) 401→로그인→200 시나리오 점검

