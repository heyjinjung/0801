# 전체 유저 지표 정의: 게임횟수 / 골드잔액 / 레벨

본 문서는 전체 유저 단위와 개별 유저 단위에서의 핵심 지표 정의와 산출 경로를 정리합니다. 기준 시각은 UTC 입니다.

## 1) 용어 및 원천 테이블
- 게임횟수(Game Count)
  - 기본: `game_stats.total_games_played` (집계 테이블)
  - 대체 산출: `user_actions`에서 게임 관련 action_type(예: SLOT_SPIN, GACHA_PULL 등) 카운트
- 골드잔액(Gold Balance)
  - 원천: `users.gold_balance` (단일 통화 기준)
- 레벨(Level)
  - 원천: `users.battlepass_level`

참고: 프런트 매핑 가이드
- 게임횟수: `stats.total_games_played`
- 접속일수(최근 30일): `stats.last_30d_active_days` (UTC 일경계)
- 골드잔액: 로그인 응답의 `gold_balance`
- 레벨: 로그인 응답의 `battlepass_level`

## 2) 개별 유저 지표 산출 SQL (PostgreSQL)
- 게임횟수(수명 전체)
```sql
SELECT u.id AS user_id,
       COALESCE(gs.total_games_played,
         (SELECT COUNT(*) FROM user_actions ua
          WHERE ua.user_id = u.id AND ua.action_type IN ('SLOT_SPIN','GACHA_PULL','GAME_PLAY'))
       ) AS total_games_played
FROM users u
LEFT JOIN game_stats gs ON gs.user_id = u.id;
```

- 최근 30일 게임횟수
```sql
SELECT u.id AS user_id,
       COUNT(*) AS games_30d
FROM users u
JOIN user_actions ua ON ua.user_id = u.id
WHERE ua.action_type IN ('SLOT_SPIN','GACHA_PULL','GAME_PLAY')
  AND ua.created_at >= (now() AT TIME ZONE 'UTC') - INTERVAL '30 days'
GROUP BY u.id;
```

- 골드잔액/레벨
```sql
SELECT id AS user_id, gold_balance, battlepass_level
FROM users;
```

## 3) 전체 유저 집계 (전사 관점)
- 전체 게임횟수 합/평균
```sql
WITH per_user AS (
  SELECT u.id AS user_id,
         COALESCE(gs.total_games_played,
           (SELECT COUNT(*) FROM user_actions ua
            WHERE ua.user_id = u.id AND ua.action_type IN ('SLOT_SPIN','GACHA_PULL','GAME_PLAY'))
         ) AS total_games
  FROM users u
  LEFT JOIN game_stats gs ON gs.user_id = u.id
)
SELECT SUM(total_games) AS total_games_all_users,
       AVG(total_games) AS avg_games_per_user
FROM per_user;
```

- 전체 골드잔액 합/중앙값(샘플: 평균으로 대체 가능)
```sql
SELECT SUM(gold_balance) AS total_gold,
       AVG(gold_balance) AS avg_gold
FROM users;
```

- 레벨 분포
```sql
SELECT battlepass_level, COUNT(*) AS users
FROM users
GROUP BY battlepass_level
ORDER BY battlepass_level;
```

## 4) API 매핑
- /api/users/stats
  - 포함 필드: `total_games_played`, `last_30d_active_days`, `lifetime_active_days`, 기타 승/패율 등
- /api/auth/me (또는 로그인 응답)
  - 포함 필드: `gold_balance`, `battlepass_level`

권장 클라이언트 매핑
- 게임횟수: stats.total_games_played
- 골드잔액: auth.me.gold_balance
- 레벨: auth.me.battlepass_level

## 5) 일관성/품질 가이드
- UTC 일경계로 30일 산정(캐시/리포트 동일 기준)
- `game_stats`가 최신이 아닌 경우 `user_actions` 폴백 적용
- 데이터 보정 시 삭제보다 UPDATE 권장, 파괴적 DDL은 사전 백업 필수

## 6) 고려 사항(엣지 케이스)
- 대규모 트래픽 시 카운트 캐시: `user:{id}:games_total` TTL 캐시 후 비동기 보정
- 통화 체계 변경 이력(듀얼→단일): `gold_balance` 기준으로 통일, 이관 스크립트 별도 관리
- 레벨 계산: 현재 `users.battlepass_level` 정수 사용(추후 경험치 기반 재계산시 마이그레이션 병행)
