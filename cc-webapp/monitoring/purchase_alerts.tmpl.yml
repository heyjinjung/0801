groups:
  - name: purchase-health
    interval: 30s
    rules:
      - alert: PurchaseFailureRateHigh
        expr: |
          sum(rate(purchase_attempt_total{result="fail"}[5m]))
            /
          clamp_min(sum(rate(purchase_attempt_total{result=~"success|fail"}[5m])), 1e-9)
            > 0.02
        for: 10m
        labels:
          severity: warning
          team: shop
        annotations:
          summary: "구매 실패율 상승"
          description: "최근 5분 평균 실패율이 2%를 초과하고 10분 지속. 결제사/네트워크/스크립트 오류 점검 필요."

      - alert: PurchasePendingSpike
        expr: |
          sum(increase(purchase_attempt_total{result="start"}[10m]))
            - sum(increase(purchase_attempt_total{result="success"}[10m]))
            - sum(increase(purchase_attempt_total{result="fail"}[10m])) > ${ALERT_PENDING_SPIKE_THRESHOLD:-20}
        for: 10m
        labels:
          severity: critical
          team: shop
        annotations:
          summary: "구매 보류 건 급증"
          description: "10분 내 pending 건수가 임계 초과. 웹훅/정산 지연 또는 외부 결제 상태 이상 가능성."

      - alert: Http5xxRateHigh
        expr: |
          sum(rate(http_requests_total{job="cc-webapp-backend",status=~"5.."}[5m]))
            /
          clamp_min(sum(rate(http_requests_total{job="cc-webapp-backend"}[5m])), 1e-9)
            > 0.02
        for: 5m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "HTTP 5xx 오류율 상승"
          description: "최근 5분간 5xx 비율 > 2%. 최근 배포/DB/캐시 상태 확인 필요."

      - alert: HttpLatencyP95High
        expr: |
          histogram_quantile(0.95, sum(rate(http_requests_duration_seconds_bucket{job="cc-webapp-backend"}[5m])) by (le)) > 0.8
        for: 10m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "HTTP P95 지연 임계 초과"
          description: "최근 10분간 P95 > 0.8s. 느린 쿼리/외부 API/락 경합 점검."
